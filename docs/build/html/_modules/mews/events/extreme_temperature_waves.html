<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mews.events.extreme_temperature_waves &mdash; MEWS 0.1 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> MEWS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MEWS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>mews.events.extreme_temperature_waves</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mews.events.extreme_temperature_waves</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Thu Oct 14 09:59:38 2021</span>

<span class="sd">@author: dlvilla</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">mews.stats</span> <span class="kn">import</span> <span class="n">Extremes</span>
<span class="kn">from</span> <span class="nn">mews.weather.psychrometrics</span> <span class="kn">import</span> <span class="n">relative_humidity</span>

<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">fsolve</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">bisect</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">erf</span>

<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">from</span> <span class="nn">calendar</span> <span class="kn">import</span> <span class="n">monthrange</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">closing</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># TODO make this a class such that erf(a) and erf(b) are not recalculated.</span>
<div class="viewcode-block" id="cdf_truncnorm"><a class="viewcode-back" href="../../../mews.events.extreme_temperature_waves.html#mews.events.extreme_temperature_waves.cdf_truncnorm">[docs]</a><span class="k">def</span> <span class="nf">cdf_truncnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="c1">#https://en.wikipedia.org/wiki/Truncated_normal_distribution</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="n">sig</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="n">sig</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="n">sig</span>
        <span class="n">erf_alpha</span> <span class="o">=</span> <span class="n">erf</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">erf</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span> <span class="o">-</span> <span class="n">erf_alpha</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">erf</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">-</span> <span class="n">erf_alpha</span><span class="p">)</span></div>

<div class="viewcode-block" id="offset_cdf_truncnorm"><a class="viewcode-back" href="../../../mews.events.extreme_temperature_waves.html#mews.events.extreme_temperature_waves.offset_cdf_truncnorm">[docs]</a><span class="k">def</span> <span class="nf">offset_cdf_truncnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">rnd</span><span class="p">):</span>
    <span class="c1">#https://en.wikipedia.org/wiki/Truncated_normal_distribution</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="n">sig</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="n">sig</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="n">sig</span>
        <span class="n">erf_alpha</span> <span class="o">=</span> <span class="n">erf</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">erf</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span> <span class="o">-</span> <span class="n">erf_alpha</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">erf</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">-</span> <span class="n">erf_alpha</span><span class="p">)</span> <span class="o">-</span> <span class="n">rnd</span></div>
    
<div class="viewcode-block" id="trunc_norm_dist"><a class="viewcode-back" href="../../../mews.events.extreme_temperature_waves.html#mews.events.extreme_temperature_waves.trunc_norm_dist">[docs]</a><span class="k">def</span> <span class="nf">trunc_norm_dist</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">minval</span><span class="p">,</span><span class="n">maxval</span><span class="p">):</span>
    <span class="c1"># inverse lookup from cdf</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">bisect</span><span class="p">(</span><span class="n">offset_cdf_truncnorm</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">rnd</span><span class="p">),</span><span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">inverse_transform_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">maxval</span><span class="p">,</span><span class="n">minval</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The bisection method failed to converge! Please investigate&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="transform_fit"><a class="viewcode-back" href="../../../mews.events.extreme_temperature_waves.html#mews.events.extreme_temperature_waves.transform_fit">[docs]</a><span class="k">def</span> <span class="nf">transform_fit</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">minval</span><span class="p">,</span><span class="n">maxval</span><span class="p">):</span>
    <span class="c1"># this function maps a logarithm from 0 to interval making for a good log-normal fit</span>
    <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span>  <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">minval</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">maxval</span> <span class="o">-</span> <span class="n">minval</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span></div>
                 
<span class="c1"># TODO - merge these functions with those in ExtremeTemperatureWaves</span>
<div class="viewcode-block" id="inverse_transform_fit"><a class="viewcode-back" href="../../../mews.events.extreme_temperature_waves.html#mews.events.extreme_temperature_waves.inverse_transform_fit">[docs]</a><span class="k">def</span> <span class="nf">inverse_transform_fit</span><span class="p">(</span><span class="n">norm_signal</span><span class="p">,</span> <span class="n">signal_max</span><span class="p">,</span> <span class="n">signal_min</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">norm_signal</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">signal_max</span> <span class="o">-</span> <span class="n">signal_min</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">+</span> <span class="n">signal_min</span> </div>



<div class="viewcode-block" id="ExtremeTemperatureWaves"><a class="viewcode-back" href="../../../mews.events.extreme_temperature_waves.html#mews.events.extreme_temperature_waves.ExtremeTemperatureWaves">[docs]</a><span class="k">class</span> <span class="nc">ExtremeTemperatureWaves</span><span class="p">(</span><span class="n">Extremes</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; ExtremeTemperatureWaves(station,</span>
<span class="sd">                                weather_files,</span>
<span class="sd">                                num_year,</span>
<span class="sd">                                use_local,</span>
<span class="sd">                                include_plots)</span>
<span class="sd">    </span>
<span class="sd">    This initializer reads and processes the heat waves and cold snap statistics</span>
<span class="sd">    for a specific NOAA station and corresponding weather data. After instantiation,</span>
<span class="sd">    the &quot;create_scenario&quot; method can be used to create weather files.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    </span>
<span class="sd">    station : str</span>
<span class="sd">        Must be a valid NOAA station number that has both daily-summary</span>
<span class="sd">        and 1991-2020 hourly climate norms data. If use_local=True, then</span>
<span class="sd">        this can be the path to a local csv file and &lt;station&gt;_norms.csv</span>
<span class="sd">        is expected in the same location for the climate norm data.</span>
<span class="sd">    </span>
<span class="sd">    weather_files : list</span>
<span class="sd">        List of path and file name strings that include all the weather files</span>
<span class="sd">        to alter</span>
<span class="sd">        </span>
<span class="sd">    num_year : int</span>
<span class="sd">        Number of years to simulate extreme wave events and global climate</span>
<span class="sd">        change into the future.</span>
<span class="sd">        </span>
<span class="sd">    start_year : int</span>
<span class="sd">        Year to start the weather files in.</span>
<span class="sd">        </span>
<span class="sd">    use_local : Bool : Optional: Default = False</span>
<span class="sd">        Flag to indicate that that &quot;station&quot; input is actually a path to</span>
<span class="sd">        local &lt;station&gt;.csv and &lt;station&gt;_norms.csv files for the NOAA data</span>
<span class="sd">        </span>
<span class="sd">    include_plots : Bool : Optional : Default = False</span>
<span class="sd">        True : plot all kinds of diagnostic information to help determine </span>
<span class="sd">        if heat waves are well characterized statistically by the data. </span>
<span class="sd">        This adds run time but is highly advised for new weather stations</span>
<span class="sd">        not previously analyzed.</span>
<span class="sd">        </span>
<span class="sd">    doe2_input : dict : Optional : Default = None</span>
<span class="sd">       | If none - process the run as E+.</span>
<span class="sd">       |</span>
<span class="sd">       | Optional input required to perform the analysis using DOE2</span>
<span class="sd">       | bin files. See mews.weather.alter. needs:</span>
<span class="sd">       |     </span>
<span class="sd">       | {&#39;doe2_bin2txt_path&#39;:OPTIONAL - path to bin2txt.exe DOE2 utility</span>
<span class="sd">       |  MEWS has a default location for this utility </span>
<span class="sd">       |  which can be obtained from DOE2 (www.doe2.com),</span>
<span class="sd">       | &#39;doe2_start_datetime&#39;:datetime indicating the start date and time</span>
<span class="sd">       | for the weather DOE2 weather file,</span>
<span class="sd">       | &#39;doe2_tz&#39;=time zone for doe2 file,</span>
<span class="sd">       | &#39;doe2_hour_in_file&#39;=8760 or 8784 for leap year,</span>
<span class="sd">       | &#39;doe2_dst&#39;= Start and end of daylight savings time for the </span>
<span class="sd">       | doe2_start_datetime year,</span>
<span class="sd">       | &#39;txt2bin_exepath&#39; : OPTIONAL - path to txt2bin.exe DOE2 utility}</span>
<span class="sd">    </span>
<span class="sd">    results_folder : str : Optional : Default = &quot;mews_results&quot;</span>
<span class="sd">        Path to the location where MEWS will write all of the output files</span>
<span class="sd">        for the requested analysis. Files will be the original weather file</span>
<span class="sd">        name with &quot;_&lt;realization&gt;_&lt;year&gt;&quot; appended to it.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1">#  These url&#39;s must end with &quot;/&quot; !</span>
    
    <span class="c1"># norms are provided in Fahrenheit!</span>
    <span class="n">norms_url</span>  <span class="o">=</span> <span class="s2">&quot;https://www.ncei.noaa.gov/data/normals-hourly/1991-2020/access/&quot;</span>
    <span class="c1"># daily data are provided in Celcius!</span>
    <span class="n">daily_url</span> <span class="o">=</span> <span class="s2">&quot;https://www.ncei.noaa.gov/data/global-historical-climatology-network-daily/access/&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">station</span><span class="p">,</span>
                 <span class="n">weather_files</span><span class="p">,</span>
                 <span class="n">use_local</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">include_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">doe2_input</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">results_folder</span><span class="o">=</span><span class="s2">&quot;mews_results&quot;</span><span class="p">,</span>
                 <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">run_parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        
        <span class="c1"># consistency checks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_NOAA_url_validity</span><span class="p">()</span>
        
        <span class="c1"># temperature specific tasks</span>
        
        <span class="k">if</span> <span class="n">include_plots</span><span class="p">:</span>
            <span class="c1"># ! TODO - move all plotting out of this class</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>

        <span class="c1"># The year is arbitrary and should simply not be a leap year</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_and_curate_NOAA_data</span><span class="p">(</span><span class="n">station</span><span class="p">,</span><span class="mi">2001</span><span class="p">,</span> <span class="n">use_local</span><span class="p">)</span>
        
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wave_stats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOAA_data</span><span class="p">,</span><span class="n">include_plots</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="n">stats</span>
        
        <span class="k">if</span> <span class="n">include_plots</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_stats_by_month</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;heat wave&quot;</span><span class="p">],</span><span class="s2">&quot;Heat Waves&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_stats_by_month</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;cold snap&quot;</span><span class="p">],</span><span class="s2">&quot;Cold Snaps&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_results_folder</span> <span class="o">=</span> <span class="n">results_folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_random_seed</span> <span class="o">=</span> <span class="n">random_seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_parallel</span> <span class="o">=</span> <span class="n">run_parallel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_doe2_input</span> <span class="o">=</span> <span class="n">doe2_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_weather_files</span> <span class="o">=</span> <span class="n">weather_files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ext_obj</span> <span class="o">=</span> <span class="p">{}</span>
        

        <span class="bp">self</span><span class="o">.</span><span class="n">extreme_results</span> <span class="o">=</span> <span class="p">{}</span>
        
        
<div class="viewcode-block" id="ExtremeTemperatureWaves.create_scenario"><a class="viewcode-back" href="../../../mews.events.extreme_temperature_waves.html#mews.events.extreme_temperature_waves.ExtremeTemperatureWaves.create_scenario">[docs]</a>    <span class="k">def</span> <span class="nf">create_scenario</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scenario_name</span><span class="p">,</span><span class="n">start_year</span><span class="p">,</span><span class="n">num_year</span><span class="p">,</span><span class="n">climate_temp_func</span><span class="p">,</span>
                        <span class="n">num_realization</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &gt;&gt;&gt; obj.create_scenario(scenario_name,start_year,num_year, climate_temp_func)</span>
<span class="sd">        </span>
<span class="sd">        Places results into self.extreme_results and self.ext_obj</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        </span>
<span class="sd">        scenario_name : str </span>
<span class="sd">            A string indicating the name of a scenario</span>
<span class="sd">        </span>
<span class="sd">        start_year : int </span>
<span class="sd">            A year (must be &gt;= 2020) that is the starting point of the analysis</span>
<span class="sd">                     </span>
<span class="sd">        num_year : int </span>
<span class="sd">            Number of subsequent years to include in the analysis</span>
<span class="sd">        </span>
<span class="sd">        climate_temp_func : func </span>
<span class="sd">            A function that provides a continuous change in temperature that</span>
<span class="sd">            is scaled to a yearly time scale. time = 2020 is the begin of the </span>
<span class="sd">            first year that is valid for the function.</span>
<span class="sd">            </span>
<span class="sd">            No valid return for values beyond 4 C due to lack of data from</span>
<span class="sd">            IPCC for higher values.</span>
<span class="sd">            </span>
<span class="sd">        num_realization : int : Optional : Default = 1</span>
<span class="sd">            Number of times to repeat the entire analysis of each weather file </span>
<span class="sd">            so that stochastic analysis can be carried out.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------    </span>
<span class="sd">        None</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        

        
        <span class="n">ext_obj_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">results_dict</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start_year</span><span class="p">,</span> <span class="n">start_year</span> <span class="o">+</span> <span class="n">num_year</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            
            
            
            <span class="n">year_no</span> <span class="o">=</span> <span class="n">year</span>
            <span class="p">(</span><span class="n">transition_matrix</span><span class="p">,</span> 
             <span class="n">transition_matrix_delta</span><span class="p">,</span>
             <span class="n">del_E_dist</span><span class="p">,</span>
             <span class="n">del_delTmax_dist</span>
             <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_transition_matrix_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">,</span><span class="n">climate_temp_func</span><span class="p">,</span><span class="n">year</span><span class="p">)</span>
            

            <span class="c1"># now initiate use of the Extremes class to unfold the process</span>
            <span class="n">ext_obj_dict</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">start_year</span><span class="p">,</span>
                     <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span><span class="n">trunc_norm_dist</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;heat wave&#39;</span><span class="p">]},</span>
                     <span class="n">del_delTmax_dist</span><span class="p">,</span>
                     <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span><span class="n">trunc_norm_dist</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;cold snap&#39;</span><span class="p">]},</span>
                     <span class="kc">None</span><span class="p">,</span>
                     <span class="n">transition_matrix</span><span class="p">,</span>
                     <span class="n">transition_matrix_delta</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_weather_files</span><span class="p">,</span>
                     <span class="n">num_realizations</span><span class="o">=</span><span class="n">num_realization</span><span class="p">,</span>
                     <span class="n">num_repeat</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">use_cython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">column</span><span class="o">=</span><span class="s1">&#39;Dry Bulb Temperature&#39;</span><span class="p">,</span>
                     <span class="n">tzname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">write_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">results_folder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_results_folder</span><span class="p">,</span>
                     <span class="n">results_append_to_name</span><span class="o">=</span><span class="n">scenario_name</span><span class="p">,</span>
                     <span class="n">run_parallel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_parallel</span><span class="p">,</span>
                     <span class="n">min_steps</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
                     <span class="n">test_shape_func</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">doe2_input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_doe2_input</span><span class="p">,</span>
                     <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_random_seed</span><span class="p">,</span>
                     <span class="n">max_E_dist</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span><span class="n">trunc_norm_dist</span><span class="p">,</span><span class="s1">&#39;param&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;heat wave&#39;</span><span class="p">]},</span>
                     <span class="n">del_max_E_dist</span><span class="o">=</span><span class="n">del_E_dist</span><span class="p">,</span>
                     <span class="n">min_E_dist</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span><span class="n">trunc_norm_dist</span><span class="p">,</span><span class="s1">&#39;param&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;cold snap&#39;</span><span class="p">]},</span>
                     <span class="n">del_min_E_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">current_year</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span>
                     <span class="n">climate_temp_func</span><span class="o">=</span><span class="n">climate_temp_func</span><span class="p">,</span>
                     <span class="n">averaging_steps</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>
        

        <span class="bp">self</span><span class="o">.</span><span class="n">extreme_results</span><span class="p">[</span><span class="n">scenario_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">results_dict</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ext_obj</span><span class="p">[</span><span class="n">scenario_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ext_obj_dict</span>
        
        <span class="k">return</span> <span class="n">results_dict</span></div>
        


    <span class="k">def</span> <span class="nf">_create_transition_matrix_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stats</span><span class="p">,</span><span class="n">climate_temp_func</span><span class="p">,</span><span class="n">year</span><span class="p">):</span>
        
        <span class="n">transition_matrix</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">transition_matrix_delta</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">del_E_dist</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">del_delTmax_dist</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Form the parameters needed by Extremes but on a monthly basis.</span>
        <span class="k">for</span> <span class="n">hot_tup</span><span class="p">,</span><span class="n">cold_tup</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;heat wave&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;cold snap&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            
            <span class="n">month</span> <span class="o">=</span> <span class="n">cold_tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cold_param</span> <span class="o">=</span> <span class="n">cold_tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">hot_param</span> <span class="o">=</span> <span class="n">hot_tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">Pwh</span> <span class="o">=</span> <span class="n">hot_param</span><span class="p">[</span><span class="s1">&#39;hourly prob of heat wave&#39;</span><span class="p">]</span>
            <span class="n">Pwsh</span> <span class="o">=</span> <span class="n">hot_param</span><span class="p">[</span><span class="s1">&#39;hourly prob stay in heat wave&#39;</span><span class="p">]</span>
            <span class="n">Pwc</span> <span class="o">=</span> <span class="n">cold_param</span><span class="p">[</span><span class="s1">&#39;hourly prob of heat wave&#39;</span><span class="p">]</span>
            <span class="n">Pwsc</span> <span class="o">=</span> <span class="n">cold_param</span><span class="p">[</span><span class="s1">&#39;hourly prob stay in heat wave&#39;</span><span class="p">]</span>
            <span class="n">transition_matrix</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="o">-</span><span class="n">Pwh</span><span class="o">-</span><span class="n">Pwc</span><span class="p">,</span><span class="n">Pwc</span><span class="p">,</span><span class="n">Pwh</span><span class="p">],</span>
                                                 <span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">Pwsc</span><span class="p">,</span> <span class="n">Pwsc</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                                                 <span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">Pwsh</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">Pwsh</span><span class="p">]])</span>
            <span class="c1"># Due to not finding information in IPCC yet, we assume that cold events</span>
            <span class="c1"># do not increase in magnitude or frequency.</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">DeltaTransition_IPCC_FigureSPM6</span><span class="p">(</span><span class="n">hot_param</span><span class="p">,</span>
                                               <span class="n">cold_param</span><span class="p">,</span>
                                               <span class="n">climate_temp_func</span><span class="p">,</span>
                                               <span class="n">year</span><span class="p">)</span>
            <span class="n">transition_matrix_delta</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">transition_matrix_delta</span>
            <span class="n">del_E_dist</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">del_E_dist</span>
            <span class="n">del_delTmax_dist</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">del_delTmax_dist</span>
             
            
        <span class="k">return</span> <span class="p">(</span><span class="n">transition_matrix</span><span class="p">,</span>
                <span class="n">transition_matrix_delta</span><span class="p">,</span>
                <span class="n">del_E_dist</span><span class="p">,</span>
                <span class="n">del_delTmax_dist</span><span class="p">)</span>
        

    <span class="k">def</span> <span class="nf">_read_and_curate_NOAA_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">station</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">use_local</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        read_NOAA_data(station,year=None,use_local=False)</span>
<span class="sd">        </span>
<span class="sd">        Reads National Oceanic and Atmospheric Association (NOAA)</span>
<span class="sd">        daily-summaries data over a long time period and</span>
<span class="sd">        NOAA climate norms hourly data from 1991-2020 from the url&#39;s</span>
<span class="sd">        self.norms_url and self.daily_url. Creates self.NOAA_data dataframe</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        This funciton is highly specific to the data formats that worked on </span>
<span class="sd">        10/14/2021 for the NOAA data repositories and will likely need significant</span>
<span class="sd">        updating if new data conventions are used by NOAA.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        station : str </span>
<span class="sd">            Must be a valid weather station ID that has a valid representation </span>
<span class="sd">            for both the self.norms_url and self.daily_url web locations</span>
<span class="sd">            the error handling provides a list of valid station ID&#39;s that</span>
<span class="sd">            meets this criterion if a valid ID is not provded.</span>
<span class="sd">        </span>
<span class="sd">        year : int </span>
<span class="sd">            The year to be assigned to the climate norms data for </span>
<span class="sd">            dataframe purposes. This year is later overlaid accross</span>
<span class="sd">            the range of the daily data</span>
<span class="sd">        </span>
<span class="sd">        use_local </span>
<span class="sd">            If MEWS is not reading web-urls use this to indicate to look</span>
<span class="sd">            for local files at &quot;station&quot; file path location. </span>
<span class="sd">                    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        NOAA_data : DataFrame </span>
<span class="sd">            Contains the daily summaries with statistical summary</span>
<span class="sd">            daily data from the climate normals overlaid so that heat and cold </span>
<span class="sd">            wave comparisons can be made.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_temp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">url</span><span class="p">,</span><span class="n">isdaily</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_url</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">norms_url</span><span class="p">],[</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">]):</span>
    
            <span class="k">if</span> <span class="n">station</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;.csv&quot;</span><span class="p">:</span>
                <span class="n">ending</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ending</span> <span class="o">=</span> <span class="s2">&quot;.csv&quot;</span>
        
            <span class="k">if</span> <span class="n">use_local</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">isdaily</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">station</span> <span class="o">+</span> <span class="n">ending</span><span class="p">,</span><span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ending</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">station</span> <span class="o">=</span> <span class="n">station</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
                        <span class="n">ending</span> <span class="o">=</span> <span class="s2">&quot;.csv&quot;</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">station</span> <span class="o">+</span> <span class="s2">&quot;_norms&quot;</span> <span class="o">+</span> <span class="n">ending</span><span class="p">)</span>
        
            <span class="k">else</span><span class="p">:</span>
                
                <span class="c1"># give a good error if the http and station number are not working.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">filestr</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">station</span><span class="o">+</span><span class="n">ending</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">exc</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The link to </span><span class="se">\n\n</span><span class="s2">&#39;&quot;</span> <span class="o">+</span> <span class="n">exc</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;&#39;</span><span class="se">\n\n</span><span class="s2">could not be found.&quot;</span>
                    <span class="k">raise</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc_unknown</span><span class="p">:</span>
                    <span class="k">raise</span><span class="p">(</span><span class="n">exc_unknown</span><span class="p">)</span> 
                
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">filestr</span><span class="p">))</span>
        
            
            <span class="k">if</span> <span class="n">isdaily</span><span class="p">:</span>
                <span class="c1"># specific processing for daily summary data.</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;DATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;DATE&#39;</span><span class="p">])</span>
                <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;DATE&#39;</span><span class="p">]</span>
        
                <span class="c1"># numbers provided are degrees Celcius in tenths.</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;TMAX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;TMAX&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">10.0</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;TMIN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;TMIN&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">10.0</span>
                <span class="n">meta_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;STATION&#39;</span><span class="p">:</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;STATION&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                             <span class="s1">&#39;LONGITUDE&#39;</span><span class="p">:</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;LONGITUDE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                             <span class="s1">&#39;LATITUDE&#39;</span><span class="p">:</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;LATITUDE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                             <span class="s1">&#39;ELEVATION&#39;</span><span class="p">:</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ELEVATION&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                             <span class="s1">&#39;NAME&#39;</span><span class="p">:</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                
                <span class="n">df_new</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;TMIN&#39;</span><span class="p">,</span><span class="s1">&#39;TMAX&#39;</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">meta_data</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="n">x</span><span class="p">))</span>
                <span class="n">keep</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;HLY-TEMP-10PCTL&quot;</span><span class="p">,</span><span class="s2">&quot;HLY-TEMP-NORMAL&quot;</span><span class="p">,</span><span class="s2">&quot;HLY-TEMP-90PCTL&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;HLY-DEWP-10PCTL&quot;</span><span class="p">,</span><span class="s2">&quot;HLY-DEWP-NORMAL&quot;</span><span class="p">,</span><span class="s2">&quot;HLY-DEWP-90PCTL&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;HLY-PRES-10PCTL&quot;</span><span class="p">,</span><span class="s2">&quot;HLY-PRES-NORMAL&quot;</span><span class="p">,</span><span class="s2">&quot;HLY-PRES-90PCTL&quot;</span><span class="p">]</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;HLY-RELH-10PCTL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;HLY-TEMP-10PCTL&quot;</span><span class="p">,</span><span class="s2">&quot;HLY-DEWP-10PCTL&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">relative_humidity</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;HLY-RELH-NORMAL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;HLY-TEMP-NORMAL&quot;</span><span class="p">,</span><span class="s2">&quot;HLY-DEWP-NORMAL&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">relative_humidity</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;HLY-RELH-90PCTL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;HLY-TEMP-90PCTL&quot;</span><span class="p">,</span><span class="s2">&quot;HLY-DEWP-90PCTL&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">relative_humidity</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                
                <span class="n">df_max</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;1D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">df_min</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;1D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">df_avg</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;1D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                
                <span class="c1"># now reconstruct the comparisons to 90% TMAX and 10% TMIN needed for hot and cold waves. No other data is needed for now </span>
                <span class="n">df_new</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_max</span><span class="p">[</span><span class="s2">&quot;HLY-TEMP-90PCTL&quot;</span><span class="p">],</span><span class="n">df_avg</span><span class="p">[</span><span class="s2">&quot;HLY-TEMP-NORMAL&quot;</span><span class="p">],</span><span class="n">df_min</span><span class="p">[</span><span class="s2">&quot;HLY-TEMP-10PCTL&quot;</span><span class="p">],</span><span class="n">df_max</span><span class="p">[</span><span class="s2">&quot;HLY-TEMP-10PCTL&quot;</span><span class="p">],</span><span class="n">df_min</span><span class="p">[</span><span class="s2">&quot;HLY-TEMP-90PCTL&quot;</span><span class="p">],</span>
                                    <span class="n">df_max</span><span class="p">[</span><span class="s2">&quot;HLY-RELH-90PCTL&quot;</span><span class="p">],</span><span class="n">df_avg</span><span class="p">[</span><span class="s2">&quot;HLY-RELH-NORMAL&quot;</span><span class="p">],</span><span class="n">df_min</span><span class="p">[</span><span class="s2">&quot;HLY-RELH-10PCTL&quot;</span><span class="p">],</span><span class="n">df_max</span><span class="p">[</span><span class="s2">&quot;HLY-RELH-10PCTL&quot;</span><span class="p">],</span><span class="n">df_min</span><span class="p">[</span><span class="s2">&quot;HLY-RELH-90PCTL&quot;</span><span class="p">],</span>
                                    <span class="n">df_max</span><span class="p">[</span><span class="s2">&quot;HLY-PRES-90PCTL&quot;</span><span class="p">],</span><span class="n">df_avg</span><span class="p">[</span><span class="s2">&quot;HLY-PRES-NORMAL&quot;</span><span class="p">],</span><span class="n">df_min</span><span class="p">[</span><span class="s2">&quot;HLY-PRES-10PCTL&quot;</span><span class="p">],</span><span class="n">df_max</span><span class="p">[</span><span class="s2">&quot;HLY-PRES-10PCTL&quot;</span><span class="p">],</span><span class="n">df_min</span><span class="p">[</span><span class="s2">&quot;HLY-PRES-90PCTL&quot;</span><span class="p">]],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">df_new</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TMAX_B&quot;</span><span class="p">,</span><span class="s2">&quot;TAVG_B&quot;</span><span class="p">,</span><span class="s2">&quot;TMIN_B&quot;</span><span class="p">,</span><span class="s2">&quot;TMAXMIN_B&quot;</span><span class="p">,</span><span class="s2">&quot;TMINMAX_B&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;HMAX_B&quot;</span><span class="p">,</span><span class="s2">&quot;HAVG_B&quot;</span><span class="p">,</span><span class="s2">&quot;HMIN_B&quot;</span><span class="p">,</span><span class="s2">&quot;HMAXMIN_B&quot;</span><span class="p">,</span><span class="s2">&quot;HMINMAX_B&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;PMAX_B&quot;</span><span class="p">,</span><span class="s2">&quot;PAVG_B&quot;</span><span class="p">,</span><span class="s2">&quot;PMIN_B&quot;</span><span class="p">,</span><span class="s2">&quot;PMAXMIN_B&quot;</span><span class="p">,</span><span class="s2">&quot;PMINMAX_B&quot;</span><span class="p">]</span>
                <span class="c1"># convert from degrees Fahrenheit</span>
                <span class="n">df_new</span><span class="p">[[</span><span class="s2">&quot;TMAX_B&quot;</span><span class="p">,</span><span class="s2">&quot;TAVG_B&quot;</span><span class="p">,</span><span class="s2">&quot;TMIN_B&quot;</span><span class="p">,</span><span class="s2">&quot;TMAXMIN_B&quot;</span><span class="p">,</span><span class="s2">&quot;TMINMAX_B&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_new</span><span class="p">[[</span>
                    <span class="s2">&quot;TMAX_B&quot;</span><span class="p">,</span><span class="s2">&quot;TAVG_B&quot;</span><span class="p">,</span><span class="s2">&quot;TMIN_B&quot;</span><span class="p">,</span><span class="s2">&quot;TMAXMIN_B&quot;</span><span class="p">,</span><span class="s2">&quot;TMINMAX_B&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="o">/</span><span class="mi">9</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mf">32.0</span><span class="p">))</span>
                        
            <span class="n">df_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_new</span><span class="p">)</span>
        <span class="n">df_daily</span> <span class="o">=</span> <span class="n">df_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df_norms</span> <span class="o">=</span> <span class="n">df_temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">NOAA_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extend_boundary_df_to_daily_range</span><span class="p">(</span><span class="n">df_norms</span><span class="p">,</span><span class="n">df_daily</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_check_NOAA_url_validity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Checks whether `url` is a valid URL.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">netloc</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
        
        <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;MEWS: Test to &quot;</span><span class="o">+</span>
                    <span class="s2">&quot;see if this url is still valid on an internet connected&quot;</span><span class="o">+</span>
                    <span class="s2">&quot; computer for NOAA and contact them if it is no longer&quot;</span><span class="o">+</span>
                    <span class="s2">&quot; working and update the source code in the &quot;</span><span class="o">+</span>
                    <span class="s2">&quot;ExtremeTemperatureWave.daily_url or .norms_url constants!&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_url</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_url</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">err_msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norms_url</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norms_url</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">err_msg</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">_extend_boundary_df_to_daily_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df_norms</span><span class="p">,</span><span class="n">df_daily</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function overlays the climate norms 90th percentile and all other columns </span>
<span class="sd">        over the daily data so that heat wave statistics can be quantified. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">df_combined</span> <span class="o">=</span> <span class="n">df_daily</span>
        
        <span class="n">unique_year</span> <span class="o">=</span> <span class="n">df_daily</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        
        <span class="c1"># verify that every year is consecutive</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">unique_year</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_year</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The daily data from NOAA has one or more gaps of a year! Please use a station that has continuous data!&quot;</span><span class="p">)</span>
        
    
        
        <span class="n">feb_28_day</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span><span class="o">.</span><span class="n">day_of_year</span>
    
        <span class="n">df_list</span> <span class="o">=</span> <span class="p">[]</span>
    
        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">unique_year</span><span class="p">:</span>
            <span class="c1"># change the df_norms so that it reflects the current year being focussed on </span>
            <span class="n">df_norms</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">([</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="p">)</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">df_norms</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>
            
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">df_daily</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year</span><span class="p">)</span>
            
            <span class="c1"># assure the data is complete.</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ind</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There is a missing day in year + </span><span class="si">{0:5d}</span><span class="s2">. This algorithm cannot handle missing days&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">b_ind</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">e_ind</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                
            <span class="n">first_date</span> <span class="o">=</span> <span class="n">df_daily</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">b_ind</span><span class="p">]</span>
            <span class="n">end_date</span> <span class="o">=</span> <span class="n">df_daily</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">e_ind</span><span class="p">]</span>
            
            <span class="n">first_day</span> <span class="o">=</span> <span class="n">first_date</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">end_day</span> <span class="o">=</span> <span class="n">end_date</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
    
            
            <span class="k">if</span> <span class="n">first_date</span><span class="o">.</span><span class="n">is_leap_year</span> <span class="ow">and</span> <span class="p">(</span><span class="n">first_day</span> <span class="o">&lt;=</span> <span class="n">feb_28_day</span> <span class="ow">and</span> <span class="n">end_day</span> <span class="o">&gt;</span> <span class="n">feb_28_day</span><span class="p">):</span>
                <span class="c1"># Feb 29 must be added </span>
                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_norms</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">first_day</span><span class="p">:</span><span class="n">feb_28_day</span><span class="p">,:])</span>
                <span class="c1"># repeat february 28th as a proxy for February 29th</span>
                <span class="n">df_feb29</span> <span class="o">=</span> <span class="n">df_norms</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">feb_28_day</span><span class="p">:</span><span class="n">feb_28_day</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span>
                <span class="n">df_feb29</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">([</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">29</span><span class="p">)])</span>
                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_feb29</span><span class="p">)</span>
                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_norms</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">feb_28_day</span><span class="p">:</span><span class="n">end_day</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># just add the range.</span>
                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_norms</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">first_day</span><span class="p">:</span><span class="n">end_day</span><span class="o">+</span><span class="mi">1</span><span class="p">,:])</span>
    
        <span class="n">df_norms_overlaid</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df_combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_daily</span><span class="p">,</span><span class="n">df_norms_overlaid</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">df_combined</span>
    
    <span class="k">def</span> <span class="nf">_isolate_waves</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">season</span><span class="p">,</span><span class="n">extreme_days</span><span class="p">):</span>
        
        <span class="n">waves_by_month</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="n">taken</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">season</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">month</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
                <span class="n">prev_month</span> <span class="o">=</span> <span class="mi">11</span>
                <span class="n">next_month</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">month</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">prev_month</span> <span class="o">=</span> <span class="mi">12</span>
                <span class="n">next_month</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prev_month</span> <span class="o">=</span> <span class="n">month</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">next_month</span> <span class="o">=</span> <span class="n">month</span> <span class="o">+</span> <span class="mi">1</span>
            
            <span class="c1"># reduce heat wave days to only the current and previous months.</span>
            <span class="n">df_wm</span> <span class="o">=</span> <span class="n">extreme_days</span><span class="p">[(</span><span class="n">extreme_days</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">prev_month</span><span class="p">)</span> <span class="o">|</span> 
                                    <span class="p">(</span><span class="n">extreme_days</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">month</span><span class="p">)</span> <span class="o">|</span>
                                    <span class="p">(</span><span class="n">extreme_days</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">next_month</span><span class="p">)]</span> 
            
            <span class="c1"># identify heat wave days and whether they are 2 or more consecutive days</span>
            <span class="n">date_diff</span> <span class="o">=</span> <span class="n">df_wm</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
            
            <span class="n">prev_date_1_day_ago</span> <span class="o">=</span> <span class="n">date_diff</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
            
            <span class="n">potential_start_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">((</span><span class="n">prev_date_1_day_ago</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">wave_consecutive_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">prev_date_1_day_ago</span><span class="o">.</span><span class="n">values</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="n">is_start_day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">potential_start_days</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">])])</span>
            
            <span class="n">start_days</span> <span class="o">=</span> <span class="n">potential_start_days</span><span class="p">[</span><span class="n">is_start_day</span><span class="p">]</span>
            
            <span class="n">all_wave_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">wave_consecutive_days</span><span class="p">,</span><span class="n">start_days</span><span class="p">])</span>
            <span class="n">all_wave_days</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            
            
            <span class="c1"># Quantify all heat waves in previous, current, and next months as a list</span>
            <span class="c1"># this does not capture the last heat wave</span>
            <span class="n">waves</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_wave_days</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">all_wave_days</span><span class="o">==</span><span class="n">s1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">all_wave_days</span><span class="o">==</span><span class="n">s2</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> 
                          <span class="k">for</span> <span class="n">s1</span><span class="p">,</span><span class="n">s2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">start_days</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">start_days</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>
            <span class="c1"># add the last heat wave.</span>
            <span class="n">waves</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start_days</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">wave_consecutive_days</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            
            <span class="c1"># Get rid of any heat waves that are outside or mostly in months. Any heat wave </span>
            <span class="c1"># directly cut in half by between months is assigned to the current month but is added to</span>
            <span class="c1"># &quot;taken&quot; so that it will not be added to the next month in the next iteration.</span>
            <span class="n">waves_by_month</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delete_waves_fully_outside_this_month</span><span class="p">(</span>
                <span class="n">waves</span><span class="p">,</span><span class="n">df_wm</span><span class="p">,</span><span class="n">month</span><span class="p">,</span><span class="n">prev_month</span><span class="p">,</span><span class="n">next_month</span><span class="p">,</span><span class="n">taken</span><span class="p">),</span><span class="n">df_wm</span><span class="p">)</span>
            
            <span class="c1"># now calculate the statistics </span>
            
        <span class="k">return</span> <span class="n">waves_by_month</span>
    
    <span class="k">def</span> <span class="nf">_determine_norm_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dist_sample</span><span class="p">):</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="n">dist_sample</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">dist_sample</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>        
            
            
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;mu&#39;</span><span class="p">:</span><span class="n">mu</span><span class="p">,</span>
                    <span class="s1">&#39;sig&#39;</span><span class="p">:</span><span class="n">sig</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_plot_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xdata</span><span class="p">,</span><span class="n">ydata</span><span class="p">,</span><span class="n">func</span><span class="p">,</span><span class="n">pvalues</span><span class="p">,</span><span class="n">fit_name</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
            
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span><span class="n">ydata</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
        
        <span class="n">xline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="mf">1.01</span><span class="o">*</span><span class="n">xdata</span><span class="o">.</span><span class="n">max</span><span class="p">(),(</span><span class="n">xdata</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">xdata</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
    
        <span class="n">yfunc</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">xline</span><span class="p">)</span>
            
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xline</span><span class="p">,</span><span class="n">yfunc</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s2">&quot;on&quot;</span><span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">fit_name</span><span class="p">)</span>
    
        
    <span class="k">def</span> <span class="nf">_plot_linear_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xdata</span><span class="p">,</span><span class="n">ydata</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">pvalues</span><span class="p">,</span><span class="n">fit_name</span><span class="p">):</span>
        
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span><span class="n">ydata</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
        
        <span class="n">xline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="mf">1.5</span><span class="o">*</span><span class="n">xdata</span><span class="o">.</span><span class="n">max</span><span class="p">(),(</span><span class="n">xdata</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">xdata</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">yline</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">xline</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yline</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">xline</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xline</span><span class="p">,</span><span class="n">yline</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s2">&quot;on&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">fit_name</span><span class="o">+</span><span class="s2">&quot;Pvalues = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pvalues</span><span class="p">))</span>
        
    
    <span class="k">def</span> <span class="nf">_transform_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">signal</span><span class="p">):</span>
        <span class="c1"># this function maps a logarithm from 0 to interval making for a good log-normal fit</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span>  <span class="p">(</span><span class="n">signal</span> <span class="o">-</span> <span class="n">signal</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">signal</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">_inverse_transform_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">norm_signal</span><span class="p">,</span> <span class="n">signal_max</span><span class="p">,</span> <span class="n">signal_min</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">norm_signal</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">signal_max</span> <span class="o">-</span> <span class="n">signal_min</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">+</span> <span class="n">signal_min</span> 
        <span class="c1">#(np.exp(norm_signal/interval) - 1.0)/(np.exp(1.0) - 1) * (signal_max - signal_min) + signal_min</span>
    
    <span class="k">def</span> <span class="nf">_calculate_wave_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">waves</span><span class="p">,</span><span class="n">frac_tot_days</span><span class="p">,</span><span class="n">time_hours</span><span class="p">,</span><span class="n">is_hw</span><span class="p">,</span><span class="n">include_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="n">include_plots</span><span class="p">:</span>
            <span class="n">fig1</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
            <span class="n">fig2</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
            <span class="n">fig3</span><span class="p">,</span> <span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
            <span class="n">fig4</span><span class="p">,</span> <span class="n">ax4</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
        
        <span class="n">hour_in_day</span> <span class="o">=</span> <span class="mi">24</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">col</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">month</span><span class="p">,</span><span class="n">tup_waves_cur</span> <span class="ow">in</span> <span class="n">waves</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># duration</span>
            <span class="n">waves_cur</span> <span class="o">=</span> <span class="n">tup_waves_cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">df_wm</span> <span class="o">=</span> <span class="n">tup_waves_cur</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="n">frac_tot_days</span><span class="p">[</span><span class="n">month</span><span class="p">]</span>
            
            <span class="c1"># calculate duration stats</span>
            <span class="n">month_duration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">waves_cur</span><span class="p">])</span>
            
            <span class="n">max_duration</span> <span class="o">=</span> <span class="n">month_duration</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            
            <span class="n">num_day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">month_duration</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">duration_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">month_duration</span> <span class="o">==</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">num_day</span><span class="p">])</span>
            <span class="n">temp_dict</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="c1"># calculate log-normal for extreme temperature difference from average conditions and total wave energy</span>
            <span class="k">if</span> <span class="n">is_hw</span><span class="p">:</span>
                <span class="n">extreme_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">df_wm</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">waves_cur</span><span class="p">[</span><span class="n">idx</span><span class="p">],:][</span><span class="s2">&quot;TMAX&quot;</span><span class="p">]</span><span class="o">-</span><span class="n">df_wm</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">waves_cur</span><span class="p">[</span><span class="n">idx</span><span class="p">],:][</span><span class="s2">&quot;TAVG_B&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">waves_cur</span><span class="p">))])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">extreme_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">df_wm</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">waves_cur</span><span class="p">[</span><span class="n">idx</span><span class="p">],:][</span><span class="s2">&quot;TMIN&quot;</span><span class="p">]</span><span class="o">-</span><span class="n">df_wm</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">waves_cur</span><span class="p">[</span><span class="n">idx</span><span class="p">],:][</span><span class="s2">&quot;TAVG_B&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">waves_cur</span><span class="p">))])</span>
            
            <span class="c1"># This produces negative energy for cold snaps and positive energy for heat waves.</span>
            <span class="n">wave_energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([((</span><span class="n">df_wm</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">waves_cur</span><span class="p">[</span><span class="n">idx</span><span class="p">],:][</span><span class="s2">&quot;TMAX&quot;</span><span class="p">]</span> 
                                    <span class="o">+</span> <span class="n">df_wm</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">waves_cur</span><span class="p">[</span><span class="n">idx</span><span class="p">],:][</span><span class="s2">&quot;TMIN&quot;</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span> 
                                   <span class="o">-</span> <span class="n">df_wm</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">waves_cur</span><span class="p">[</span><span class="n">idx</span><span class="p">],:][</span><span class="s2">&quot;TAVG_B&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
                                   <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">waves_cur</span><span class="p">))])</span>
            
            <span class="c1"># convert from C*day to C*hr and day to hr</span>
            <span class="n">wave_energy_C_hr</span> <span class="o">=</span> <span class="n">wave_energy</span> <span class="o">*</span> <span class="n">hour_in_day</span>
            <span class="n">month_duration_hr</span> <span class="o">=</span> <span class="n">month_duration</span> <span class="o">*</span> <span class="n">hour_in_day</span>
            
            <span class="c1"># choose the extremum that is appropriate for the two types of waves (hot/cold)</span>
            <span class="k">if</span> <span class="n">is_hw</span><span class="p">:</span>
                <span class="n">norm_extreme_temp</span> <span class="o">=</span> <span class="n">extreme_temp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">norm_energy</span> <span class="o">=</span> <span class="n">wave_energy_C_hr</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">norm_extreme_temp</span> <span class="o">=</span> <span class="n">extreme_temp</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">norm_energy</span> <span class="o">=</span> <span class="n">wave_energy_C_hr</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            
            <span class="n">month_duration_norm</span> <span class="o">=</span> <span class="n">month_duration_hr</span> <span class="o">/</span> <span class="n">month_duration_hr</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">wave_energy_norm</span> <span class="o">=</span> <span class="n">wave_energy_C_hr</span><span class="o">/</span><span class="n">norm_energy</span>
            <span class="n">extreme_temp_norm</span> <span class="o">=</span> <span class="n">extreme_temp</span><span class="o">/</span><span class="n">norm_extreme_temp</span>
            
            <span class="c1"># since all hw are exactly one day, the second term reduces to a constant offset term.</span>
            <span class="n">size_tup</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">month_duration</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">energy_regression_vars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">month_duration_norm</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">size_tup</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">max_temp_regression_vars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">size_tup</span><span class="p">)),</span>
                 <span class="p">(</span><span class="n">month_duration_norm</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">size_tup</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
    
            
            <span class="n">y_regression</span> <span class="o">=</span> <span class="p">[</span><span class="n">wave_energy_norm</span><span class="p">,</span><span class="n">extreme_temp_norm</span><span class="p">]</span>
            <span class="n">X_regression</span> <span class="o">=</span> <span class="p">[</span><span class="n">energy_regression_vars</span><span class="p">,</span><span class="n">max_temp_regression_vars</span><span class="p">]</span>
            
            <span class="n">results_shape_coef</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">par</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">y_reg</span><span class="p">,</span><span class="n">X_reg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">y_regression</span><span class="p">,</span><span class="n">X_regression</span><span class="p">):</span>
            
                <span class="n">model_shape_coef</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y_reg</span><span class="p">,</span><span class="n">X_reg</span><span class="p">)</span>
            
                <span class="n">results_shape_coef</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_shape_coef</span><span class="o">.</span><span class="n">fit</span><span class="p">())</span>
                
                <span class="n">par</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results_shape_coef</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            
            <span class="c1"># be careful, the function assumes that the first term is the constant term</span>
            <span class="c1"># but here it is the slope making reversal of the params fit </span>
            
    
            <span class="n">E_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">D</span><span class="p">:</span> <span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">D</span><span class="p">)</span>
            <span class="n">T_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">D</span><span class="p">:</span> <span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">D</span><span class="p">)</span>
    
            <span class="k">if</span> <span class="n">include_plots</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_plot_fit</span><span class="p">(</span><span class="n">month_duration_norm</span><span class="p">,</span><span class="n">wave_energy_norm</span><span class="p">,</span>
                                <span class="n">E_func</span><span class="p">,</span> 
                                <span class="n">results_shape_coef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pvalues</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">),</span><span class="n">ax1</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">])</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">_plot_fit</span><span class="p">(</span><span class="n">month_duration_norm</span><span class="p">,</span><span class="n">extreme_temp_norm</span><span class="p">,</span>
                                <span class="n">T_func</span><span class="p">,</span> 
                                <span class="n">results_shape_coef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pvalues</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">),</span><span class="n">ax2</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">])</span>

            <span class="c1"># Calculate the linear growth of energy with duration based on the mean</span>
            <span class="n">wave_energy_per_duration</span> <span class="o">=</span> <span class="n">wave_energy_C_hr</span> <span class="o">/</span> <span class="p">(</span><span class="n">norm_energy</span> <span class="o">*</span> <span class="n">E_func</span><span class="p">(</span><span class="n">month_duration_norm</span><span class="p">))</span>   <span class="c1"># deg C * hr / hr</span>
            <span class="n">extreme_temp_per_duration</span> <span class="o">=</span> <span class="n">extreme_temp</span> <span class="o">/</span> <span class="p">(</span><span class="n">norm_extreme_temp</span> <span class="o">*</span> <span class="n">T_func</span><span class="p">(</span><span class="n">month_duration_norm</span><span class="p">))</span>
            
            <span class="c1"># transform to a common interval</span>
            <span class="n">wave_energy_per_duration_norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_fit</span><span class="p">(</span><span class="n">wave_energy_per_duration</span><span class="p">)</span>
            <span class="n">extreme_temp_per_duration_norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_fit</span><span class="p">(</span><span class="n">extreme_temp_per_duration</span><span class="p">)</span>
            
            
            <span class="k">if</span> <span class="n">include_plots</span><span class="p">:</span>
                <span class="n">ax3</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">wave_energy_per_duration_norm</span><span class="p">)</span>
                <span class="n">ax4</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">extreme_temp_per_duration_norm</span><span class="p">)</span>

            <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;These statistics are already mapped&quot;</span><span class="o">+</span>
                                <span class="s2">&quot; from -1 ... 1 and _inverse_transform_fit is&quot;</span><span class="o">+</span>
                                <span class="s2">&quot; needed to return to actual degC and&quot;</span><span class="o">+</span>
                                <span class="s2">&quot; degC*hr values. If input of actual values is desired use transform_fit(X,max,min)&quot;</span><span class="p">)</span>
            <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;energy_normal_param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_norm_param</span><span class="p">(</span><span class="n">wave_energy_per_duration_norm</span><span class="p">)</span>
            <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;extreme_temp_normal_param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_norm_param</span><span class="p">(</span><span class="n">extreme_temp_per_duration_norm</span><span class="p">)</span>
            <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;max extreme temp per duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extreme_temp_per_duration</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;min extreme temp per duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extreme_temp_per_duration</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;max energy per duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wave_energy_per_duration</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;min energy per duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wave_energy_per_duration</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;energy linear slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;normalized extreme temp duration fit slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;normalized extreme temp duration fit intercept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;normalizing energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm_energy</span>
            <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;normalizing extreme temp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm_extreme_temp</span>
            <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;normalizing duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">month_duration_hr</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            
            <span class="c1">#</span>
            <span class="c1"># Markov chain model parameter estimation</span>
            <span class="c1">#</span>
            <span class="n">hour_in_cur_month</span> <span class="o">=</span> <span class="n">time_hours</span> <span class="o">*</span> <span class="n">frac</span>
            <span class="c1"># for Markov chain model of heat wave initiation. </span>
            <span class="n">prob_of_wave_in_any_hour</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">month_duration</span><span class="p">)</span><span class="o">/</span><span class="n">hour_in_cur_month</span>
            
            <span class="c1"># for Markov chain model of probability a heat wave will continue into </span>
            <span class="c1"># the next hour a linear regression is needed here</span>
            
            <span class="n">num_hour_per_event_duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">duration_history</span> <span class="o">*</span> <span class="n">num_day</span><span class="p">)</span><span class="o">*</span><span class="n">hour_in_day</span>
            
            <span class="c1"># We are fitting P(n) = P0^n, where P0 is the variable desired to determine and is the</span>
            <span class="c1"># Markov probability of transition out of the heat wave state based on the duration data.</span>
            <span class="c1"># this is a linear fit if we take the logarithm.</span>
            <span class="n">prob_per_event</span> <span class="o">=</span> <span class="n">num_hour_per_event_duration</span><span class="o">/</span><span class="n">num_hour_per_event_duration</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            
            <span class="n">included</span> <span class="o">=</span> <span class="n">prob_per_event</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="c1"># drop any heat wave durations that have no data!</span>
            
            <span class="n">log_prob_duration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prob_per_event</span><span class="p">[</span><span class="n">included</span><span class="p">])</span>
            
            <span class="n">num_hour_passed</span> <span class="o">=</span> <span class="n">num_day</span><span class="p">[</span><span class="n">included</span><span class="p">]</span> <span class="o">*</span> <span class="n">hour_in_day</span>
            
            <span class="n">num_hour_passed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">num_hour_passed</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">log_prob_duration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">log_prob_duration</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">log_prob_duration</span><span class="p">,</span><span class="n">num_hour_passed</span><span class="p">)</span>
            
            <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
            
            <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            
            <span class="c1"># verify that the result is significant by p-value &lt; 0.05 i.e. </span>
            <span class="c1"># the probability that the null hypothesis is true (i.e. your results </span>
            <span class="c1"># is a random chance occurance is &lt;5%)</span>
            <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">pvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_plot_linear_fit</span><span class="p">(</span><span class="n">log_prob_duration</span><span class="p">,</span><span class="n">num_hour_passed</span><span class="p">,</span><span class="n">results</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="n">results</span><span class="o">.</span><span class="n">pvalues</span><span class="p">,</span>
                                <span class="s2">&quot;Month=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; Markov probability&quot;</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The weather data has produced a low p-value fit&quot;</span><span class="o">+</span>
                                 <span class="s2">&quot; for Markov process fits! More data is needed &quot;</span><span class="o">+</span>
                                 <span class="s2">&quot;to produce a statistically significant result!&quot;</span><span class="p">)</span>
                    
            <span class="c1"># normalize and assume that the probability of going to a cold snap </span>
            <span class="c1"># directly from a heat wave is zero.</span>
            <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;hourly prob stay in heat wave&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">P0</span> 
            <span class="n">temp_dict</span><span class="p">[</span><span class="s1">&#39;hourly prob of heat wave&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob_of_wave_in_any_hour</span>
            
            <span class="n">stats</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_dict</span>
            
            <span class="n">col</span><span class="o">+=</span><span class="mi">1</span>
            
        
            
        <span class="k">return</span> <span class="n">stats</span>
    
    
    <span class="k">def</span> <span class="nf">_wave_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df_combined</span><span class="p">,</span><span class="n">include_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        wave_stats(df_combined,is_heat)</span>
<span class="sd">        </span>
<span class="sd">        Calculates the statistical parameter per month for heat waves or cold snaps</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------    </span>
<span class="sd">        df_combined : pd.DataFrame</span>
<span class="sd">            A combined data set of NOAA historical</span>
<span class="sd">            daily data and NOAA climate 10%, 50%, and 90% data</span>
<span class="sd">            Violation of the 90% (for heat waves) or 10% data</span>
<span class="sd">            is how heat wave days are identified.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mews_stats : dict </span>
<span class="sd">            A dictionary of mews statstics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># total time covered by the dataset</span>
        <span class="n">seconds_in_hour</span> <span class="o">=</span> <span class="mf">3600.0</span>
        <span class="n">months_per_year</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">time_hours</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_combined</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_combined</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="n">seconds_in_hour</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="n">is_heat_wave</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">is_hw</span> <span class="ow">in</span> <span class="n">is_heat_wave</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">is_hw</span><span class="p">:</span>
                <span class="c1"># above 90% criterion for TMAX_B or above the 90% criterion for the hourly maximum minimum temperature</span>
                <span class="n">extreme_days</span> <span class="o">=</span> <span class="n">df_combined</span><span class="p">[(</span><span class="n">df_combined</span><span class="p">[</span><span class="s2">&quot;TMAX&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df_combined</span><span class="p">[</span><span class="s2">&quot;TMAX_B&quot;</span><span class="p">])</span><span class="o">|</span>
                                             <span class="p">(</span><span class="n">df_combined</span><span class="p">[</span><span class="s2">&quot;TMIN&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df_combined</span><span class="p">[</span><span class="s2">&quot;TMINMAX_B&quot;</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># below 10% criterion TMIN or below 10% criterion for the minimum hourly maximum temperature</span>
                <span class="n">extreme_days</span> <span class="o">=</span> <span class="n">df_combined</span><span class="p">[(</span><span class="n">df_combined</span><span class="p">[</span><span class="s2">&quot;TMIN&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df_combined</span><span class="p">[</span><span class="s2">&quot;TMIN_B&quot;</span><span class="p">])</span><span class="o">|</span>
                                             <span class="p">(</span><span class="n">df_combined</span><span class="p">[</span><span class="s2">&quot;TMAX&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df_combined</span><span class="p">[</span><span class="s2">&quot;TMAXMIN_B&quot;</span><span class="p">])]</span>
            
            <span class="c1"># this is the number of heat wave days each month over the entire time period</span>
            <span class="n">num_days_each_month</span> <span class="o">=</span> <span class="n">extreme_days</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">extreme_days</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()[</span><span class="s2">&quot;TMIN&quot;</span><span class="p">]</span> <span class="c1">#TMIN just makes it a series</span>
            
            <span class="c1"># this is the total days in each month.</span>
            <span class="n">num_total_days</span> <span class="o">=</span> <span class="n">df_combined</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df_combined</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()[</span><span class="s2">&quot;TMIN&quot;</span><span class="p">]</span>
            <span class="n">frac_tot_days</span> <span class="o">=</span> <span class="n">num_total_days</span><span class="o">/</span><span class="n">num_total_days</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            
            <span class="n">months</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">months_per_year</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="c1"># do a different assessment for each month in the heat wave season because </span>
            <span class="c1"># the statistics show a significant peak at the end of summer and we do not</span>
            <span class="c1"># want the probability to be smeared out as a result.</span>
            
            <span class="c1"># we need to determine if the month starts or ends with heat waves. If it does,</span>
            <span class="c1"># the month with more days gets the heat wave. If its a tie, then the current month</span>
            <span class="c1"># gets the heat wave and the heat wave is marked as taken so that it is </span>
            <span class="c1"># not double counted</span>
                
        
            <span class="c1"># now the last false before a true is the start of each heat wave </span>
            <span class="c1"># then true until the next false is the duration of the heat wave</span>
            <span class="n">waves_all_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isolate_waves</span><span class="p">(</span><span class="n">months</span><span class="p">,</span><span class="n">extreme_days</span><span class="p">)</span> 
            
            <span class="k">if</span> <span class="n">is_hw</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;heat wave&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;cold snap&quot;</span>
            
            <span class="n">stats</span><span class="p">[</span><span class="n">description</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_wave_stats</span><span class="p">(</span><span class="n">waves_all_year</span><span class="p">,</span>
                                                            <span class="n">frac_tot_days</span><span class="p">,</span>
                                                            <span class="n">time_hours</span><span class="p">,</span>
                                                            <span class="n">is_hw</span><span class="p">,</span>
                                                            <span class="n">include_plots</span><span class="p">)</span>
        
        
        <span class="k">return</span> <span class="n">stats</span>
    
    <span class="k">def</span> <span class="nf">_plot_stats_by_month</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stats</span><span class="p">,</span><span class="n">title_string</span><span class="p">):</span>
        
        <span class="n">mu</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">muT</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sigT</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">p_hw</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ps_hw</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">months</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">month</span><span class="p">,</span><span class="n">modat</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">logdat</span> <span class="o">=</span> <span class="n">modat</span><span class="p">[</span><span class="s1">&#39;energy_normal_param&#39;</span><span class="p">]</span>
            <span class="n">logdelT</span> <span class="o">=</span> <span class="n">modat</span><span class="p">[</span><span class="s1">&#39;extreme_temp_normal_param&#39;</span><span class="p">]</span>
            <span class="n">mu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logdat</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">])</span>
            <span class="n">sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logdat</span><span class="p">[</span><span class="s1">&#39;sig&#39;</span><span class="p">])</span>
            <span class="n">muT</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logdelT</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">])</span>
            <span class="n">sigT</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logdelT</span><span class="p">[</span><span class="s1">&#39;sig&#39;</span><span class="p">])</span>
            <span class="n">months</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>
            
            <span class="n">p_hw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">modat</span><span class="p">[</span><span class="s1">&#39;hourly prob of heat wave&#39;</span><span class="p">])</span>
            <span class="n">ps_hw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">modat</span><span class="p">[</span><span class="s1">&#39;hourly prob stay in heat wave&#39;</span><span class="p">])</span>
        
        <span class="n">fontsize</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span><span class="s1">&#39;text.usetex&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">}</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fontsize</span><span class="p">)</span>    
           
        <span class="n">fig</span><span class="p">,</span><span class="n">axl</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
        
        <span class="n">dat</span> <span class="o">=</span> <span class="p">[</span><span class="n">mu</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">muT</span><span class="p">,</span><span class="n">sigT</span><span class="p">,</span><span class="n">p_hw</span><span class="p">,</span><span class="n">ps_hw</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;$\mu_{\Delta E}$&quot;</span><span class="p">,</span><span class="s2">&quot;$\sigma_{\Delta E}$&quot;</span><span class="p">,</span><span class="s2">&quot;$\mu_{\Delta T}$&quot;</span><span class="p">,</span><span class="s2">&quot;$\sigma_{\Delta T}$&quot;</span><span class="p">,</span><span class="s2">&quot;$P_</span><span class="si">{w}</span><span class="s2">$&quot;</span><span class="p">,</span><span class="s2">&quot;$P_</span><span class="si">{sw}</span><span class="s2">$&quot;</span><span class="p">]</span>
        
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ax</span><span class="p">,</span><span class="n">da</span><span class="p">,</span><span class="n">na</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axl</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
            <span class="n">idx</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">months</span><span class="p">,</span><span class="n">da</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">na</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s2">&quot;on&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">13</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
                    <span class="n">label</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">axl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_string</span><span class="p">)</span>
        <span class="n">axl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Month&quot;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">title_string</span><span class="o">+</span><span class="s2">&quot;_monthly_MEWS_parameter_results.png&quot;</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        
        
    
    
    <span class="k">def</span> <span class="nf">_delete_waves_fully_outside_this_month</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">heat_waves</span><span class="p">,</span><span class="n">df_wm</span><span class="p">,</span><span class="n">month</span><span class="p">,</span><span class="n">prev_month</span><span class="p">,</span><span class="n">next_month</span><span class="p">,</span><span class="n">hw_taken</span><span class="p">):</span>
        
        <span class="n">keep_ind</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">hw</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">heat_waves</span><span class="p">):</span>
    
            <span class="n">df_wave_ind</span> <span class="o">=</span> <span class="n">df_wm</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">hw</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="c1"># on boundary</span>
            <span class="n">numday_in_month</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_wave_ind</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">numday_in_month</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c1"># do nothing, the entire heat wave is in a previous</span>
                     <span class="c1"># or posthumous month. this heat wave will not be included in keep_ind</span>
            <span class="k">else</span><span class="p">:</span>        
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_wave_ind</span><span class="p">)</span> <span class="o">!=</span> <span class="n">numday_in_month</span><span class="p">:</span>
                    <span class="c1"># we have a boundary violation and we need to deal with it</span>
                    <span class="n">num_prev</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_wave_ind</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">prev_month</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">num_next</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_wave_ind</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">next_month</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>    
                    
                    <span class="k">if</span> <span class="n">num_prev</span> <span class="o">&gt;</span> <span class="n">numday_in_month</span> <span class="ow">and</span> <span class="n">num_prev</span> <span class="o">&gt;</span> <span class="n">num_next</span><span class="p">:</span>
                        <span class="c1"># the heat wave belongs in the previous month</span>
                        <span class="k">pass</span>
                    <span class="k">elif</span> <span class="n">num_next</span> <span class="o">&gt;</span> <span class="n">numday_in_month</span> <span class="ow">and</span> <span class="n">num_next</span> <span class="o">&gt;</span> <span class="n">num_prev</span><span class="p">:</span>
                        <span class="c1"># the heat wave belongs to the next month</span>
                        <span class="k">pass</span>
                    <span class="k">elif</span> <span class="p">((</span><span class="n">num_next</span> <span class="o">==</span> <span class="n">numday_in_month</span> <span class="ow">and</span> <span class="n">num_next</span> <span class="o">&gt;</span> <span class="n">num_prev</span><span class="p">)</span> <span class="ow">or</span>
                         <span class="p">(</span><span class="n">num_prev</span> <span class="o">==</span> <span class="n">numday_in_month</span> <span class="ow">and</span> <span class="n">num_prev</span> <span class="o">&gt;</span> <span class="n">num_next</span><span class="p">)</span> <span class="ow">or</span>
                         <span class="p">(</span><span class="n">num_next</span> <span class="o">==</span> <span class="n">num_prev</span><span class="p">)):</span>
                        <span class="c1"># this heat wave is given to the current month but must also be marked as taken since</span>
                        <span class="c1"># it will also qualify to be taken by the next month.</span>
                        <span class="n">wave_is_taken</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">for</span> <span class="n">dfhw</span> <span class="ow">in</span> <span class="n">hw_taken</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">df_wave_ind</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">dfhw</span><span class="p">):</span>
                                <span class="n">wave_is_taken</span> <span class="o">=</span> <span class="kc">True</span>
                        
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">wave_is_taken</span><span class="p">:</span>
                            <span class="n">hw_taken</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_wave_ind</span><span class="p">)</span>
                            <span class="n">keep_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                            
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># the majority of days are in the current month and the heat wave belongs </span>
                          <span class="c1"># to the current month.</span>
                        <span class="n">keep_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># no changes needed, the heat wave is fully in the current month.</span>
                    <span class="n">keep_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        
        <span class="n">cur_month_heat_waves</span> <span class="o">=</span> <span class="p">[</span><span class="n">heat_waves</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">keep_ind</span><span class="p">]</span>
    
        <span class="k">return</span> <span class="n">cur_month_heat_waves</span></div>
            
<div class="viewcode-block" id="DeltaTransition_IPCC_FigureSPM6"><a class="viewcode-back" href="../../../mews.events.extreme_temperature_waves.html#mews.events.extreme_temperature_waves.DeltaTransition_IPCC_FigureSPM6">[docs]</a><span class="k">class</span> <span class="nc">DeltaTransition_IPCC_FigureSPM6</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; obj = DeltaTransition_IPCC_FigureSPM6(hot_param,</span>
<span class="sd">                                              cold_param,</span>
<span class="sd">                                              climate_temp_func,</span>
<span class="sd">                                              year)</span>
<span class="sd">    </span>
<span class="sd">    This class assumes that we can divide by the 1.0 C multipliers for the present</span>
<span class="sd">    day and then multiply. We interpolate linearly or extrapolate linearly from</span>
<span class="sd">    the sparse data available.</span>
<span class="sd">    </span>
<span class="sd">    This is called within the context of a specific month.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">hot_param</span><span class="p">,</span><span class="n">cold_param</span><span class="p">,</span><span class="n">climate_temp_func</span><span class="p">,</span><span class="n">year</span><span class="p">):</span>
                
        <span class="c1"># bring in the ipcc data and process it.</span>
        <span class="nb">print</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="n">ipcc_data</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s2">&quot;data&quot;</span><span class="p">,</span><span class="s2">&quot;IPCC_FigureSPM_6.csv&quot;</span><span class="p">))</span>
        
        <span class="c1"># neglect leap years</span>
        <span class="n">hours_in_10_years</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">24</span>  <span class="c1"># hours in 10 years</span>
        <span class="n">hours_in_50_years</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">hours_in_10_years</span>
        
        <span class="c1"># switch to the paper notation</span>
        <span class="n">N10</span> <span class="o">=</span> <span class="n">hours_in_10_years</span>
        <span class="n">N50</span> <span class="o">=</span> <span class="n">hours_in_50_years</span>
        <span class="c1"># probability a heat wave begins</span>
        <span class="n">Phwm</span> <span class="o">=</span> <span class="n">hot_param</span><span class="p">[</span><span class="s2">&quot;hourly prob of heat wave&quot;</span><span class="p">]</span>
        <span class="c1"># probability a heat wave is sustainted</span>
        <span class="n">Phwsm</span> <span class="o">=</span> <span class="n">hot_param</span><span class="p">[</span><span class="s2">&quot;hourly prob stay in heat wave&quot;</span><span class="p">]</span>
        <span class="c1"># probability of a cold snap</span>
        <span class="n">Pcsm</span> <span class="o">=</span> <span class="n">cold_param</span><span class="p">[</span><span class="s2">&quot;hourly prob of heat wave&quot;</span><span class="p">]</span>
        <span class="c1"># probability of sustaining a cold snap</span>
        <span class="n">Pcssm</span> <span class="o">=</span> <span class="n">cold_param</span><span class="p">[</span><span class="s2">&quot;hourly prob stay in heat wave&quot;</span><span class="p">]</span>
        
        <span class="c1"># This is change in global temperature from 2020!</span>
        <span class="n">delta_TG</span> <span class="o">=</span> <span class="n">climate_temp_func</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
        
        
        <span class="c1"># now interpolate from the IPCC tables </span>
        <span class="p">(</span><span class="n">ipcc_val_10</span><span class="p">,</span> <span class="n">ipcc_val_50</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interpolate_ipcc_data</span><span class="p">(</span><span class="n">ipcc_data</span><span class="p">,</span> <span class="n">delta_TG</span><span class="p">)</span>
        <span class="n">f_ipcc_50_10</span> <span class="o">=</span> <span class="n">ipcc_val_10</span><span class="p">[</span><span class="s2">&quot;Average Increase in Frequency&quot;</span><span class="p">]</span> 
        <span class="n">f_ipcc_50_50</span> <span class="o">=</span> <span class="n">ipcc_val_50</span><span class="p">[</span><span class="s2">&quot;Average Increase in Frequency&quot;</span><span class="p">]</span>
        
        <span class="c1"># equation 22 (number may change)</span>
        <span class="n">P_prime_hwm</span> <span class="o">=</span> <span class="n">Phwm</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_ipcc_50_50</span> <span class="o">*</span> <span class="n">N10</span> <span class="o">+</span> <span class="n">f_ipcc_50_10</span> <span class="o">*</span> <span class="n">N50</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">N10</span> <span class="o">+</span> <span class="n">N50</span><span class="p">)</span>
        
        
        
        <span class="c1"># Estimate the interval positions of the 10 year and 50 year changes</span>
        <span class="c1"># in temperature.</span>
        <span class="c1"># equation 23 - all statistics have been translated to -1, 1, -1 is the minimum </span>
        <span class="c1">#               extreme temperature and 1 is the maximum extreme temperature</span>
        <span class="n">normalized_ext_temp</span> <span class="o">=</span> <span class="n">hot_param</span><span class="p">[</span><span class="s1">&#39;extreme_temp_normal_param&#39;</span><span class="p">]</span>
        <span class="n">normalized_energy</span> <span class="o">=</span> <span class="n">hot_param</span><span class="p">[</span><span class="s1">&#39;energy_normal_param&#39;</span><span class="p">]</span>
        <span class="n">maxtemp</span> <span class="o">=</span> <span class="n">hot_param</span><span class="p">[</span><span class="s1">&#39;max extreme temp per duration&#39;</span><span class="p">]</span>
        <span class="n">mintemp</span> <span class="o">=</span> <span class="n">hot_param</span><span class="p">[</span><span class="s1">&#39;min extreme temp per duration&#39;</span><span class="p">]</span>
        
        <span class="n">norm_energy</span> <span class="o">=</span> <span class="n">hot_param</span><span class="p">[</span><span class="s1">&#39;normalizing energy&#39;</span><span class="p">]</span>
        <span class="n">norm_temp</span> <span class="o">=</span> <span class="n">hot_param</span><span class="p">[</span><span class="s1">&#39;normalizing extreme temp&#39;</span><span class="p">]</span>
        <span class="n">norm_duration</span> <span class="o">=</span> <span class="n">hot_param</span><span class="p">[</span><span class="s1">&#39;normalizing duration&#39;</span><span class="p">]</span>
        <span class="n">alphaT</span> <span class="o">=</span> <span class="n">hot_param</span><span class="p">[</span><span class="s1">&#39;normalized extreme temp duration fit slope&#39;</span><span class="p">]</span>
        <span class="n">betaT</span> <span class="o">=</span> <span class="n">hot_param</span><span class="p">[</span><span class="s1">&#39;normalized extreme temp duration fit intercept&#39;</span><span class="p">]</span>
        
        <span class="n">mu_norm</span> <span class="o">=</span> <span class="n">normalized_ext_temp</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">]</span>
        <span class="n">sig_norm</span> <span class="o">=</span> <span class="n">normalized_ext_temp</span><span class="p">[</span><span class="s1">&#39;sig&#39;</span><span class="p">]</span>
        
        <span class="c1"># solve for the 10 year and 50 year expected peak temperature per duration</span>
        <span class="n">F0</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">cdf_truncnorm</span><span class="p">(</span><span class="n">transform_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mintemp</span><span class="p">,</span><span class="n">maxtemp</span><span class="p">),</span>
                                     <span class="n">mu_norm</span><span class="p">,</span>
                                     <span class="n">sig_norm</span><span class="p">,</span>
                                     <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">S10</span> <span class="o">=</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">N10</span> <span class="o">*</span> <span class="n">Phwm</span><span class="p">)</span>
        <span class="n">S50</span> <span class="o">=</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">N50</span> <span class="o">*</span> <span class="n">Phwm</span><span class="p">)</span>
        
        <span class="n">F10</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">F0</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">S10</span>
        <span class="n">F50</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">F0</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">S50</span>
        <span class="n">delTmax10_hwm</span><span class="p">,</span> <span class="n">r10</span> <span class="o">=</span> <span class="n">bisect</span><span class="p">(</span><span class="n">F10</span><span class="p">,</span><span class="n">mintemp</span><span class="p">,</span><span class="n">maxtemp</span><span class="p">,</span><span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">delTmax50_hwm</span><span class="p">,</span> <span class="n">r50</span> <span class="o">=</span> <span class="n">bisect</span><span class="p">(</span><span class="n">F50</span><span class="p">,</span><span class="n">mintemp</span><span class="p">,</span><span class="n">maxtemp</span><span class="p">,</span><span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">r10</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bisection method failed to find 10 year expected value for heat wave temperature&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">r50</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bisection method failed to find 50 year expected value for heat wave temperature&quot;</span><span class="p">)</span>
            
        <span class="c1"># Find the -1..1 interval shift parameters that reflect the IPCC shift amounts</span>
        <span class="c1"># in temperature for 10 and 50 year events. This can shift and stretch the distribution.</span>
        <span class="c1"># solve for the shift in mean and standard deviation (2 equations two unknowns)</span>
        <span class="c1"># equation 24 in the writeup</span>
        
        <span class="c1"># sig_s and mu_s are the independent shift and stretch variables that </span>
        <span class="c1"># are solvede as two unknowns. They are calculated within the original -1..1</span>
        <span class="c1"># interval and are not dimensional.. use inverse_transform_fit to give them</span>
        <span class="c1"># dimensions.</span>
        
        <span class="c1"># function for the establishment of truncated Gaussian shifting </span>
        <span class="c1"># due to increasing maximum temperatures from</span>
        <span class="c1"># the original -1 .. 1 interval to a new interval S_m1 to S_1</span>
        <span class="c1"># this funciton is used by fsolve below</span>
        
        <span class="c1"># must normalize by duration</span>

        <span class="n">D10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">Phwm</span> <span class="o">*</span> <span class="n">N10</span><span class="p">)))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Phwsm</span><span class="p">)</span>  <span class="c1"># in hours - expected value</span>
        <span class="n">D50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">Phwm</span> <span class="o">*</span> <span class="n">N50</span><span class="p">)))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Phwsm</span><span class="p">)</span>  <span class="c1"># in hours - expected value</span>
        
        <span class="c1"># IPCC values must be normalized per duration to assure the correct amount</span>
        <span class="c1"># is added.</span>
        <span class="n">new_delT_10</span> <span class="o">=</span> <span class="n">delTmax10_hwm</span> <span class="o">+</span> <span class="n">ipcc_val_10</span><span class="p">[</span><span class="s2">&quot;Avg Increase in Intensity&quot;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span>
            <span class="n">norm_temp</span> <span class="o">*</span> <span class="p">(</span><span class="n">alphaT</span> <span class="o">*</span> <span class="p">(</span><span class="n">D10</span><span class="o">/</span><span class="n">norm_duration</span><span class="p">)</span> <span class="o">+</span> <span class="n">betaT</span><span class="p">))</span>
        <span class="n">new_delT_50</span> <span class="o">=</span> <span class="n">delTmax50_hwm</span> <span class="o">+</span> <span class="n">ipcc_val_50</span><span class="p">[</span><span class="s2">&quot;Avg Increase in Intensity&quot;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span>
            <span class="n">norm_temp</span> <span class="o">*</span> <span class="p">(</span><span class="n">alphaT</span> <span class="o">*</span> <span class="p">(</span><span class="n">D50</span><span class="o">/</span><span class="n">norm_duration</span><span class="p">)</span> <span class="o">+</span> <span class="n">betaT</span><span class="p">))</span>
        <span class="k">def</span> <span class="nf">F10_50_S</span><span class="p">(</span><span class="n">npar</span><span class="p">):</span>
            
            <span class="n">mu_s</span><span class="p">,</span><span class="n">sig_s</span> <span class="o">=</span> <span class="n">npar</span>
            <span class="n">S_m1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">mu_s</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">mu_norm</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sig_norm</span><span class="p">)</span> <span class="o">*</span> <span class="n">sig_s</span>
            <span class="n">S_1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">mu_s</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">mu_norm</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sig_norm</span><span class="p">)</span> <span class="o">*</span> <span class="n">sig_s</span>
            <span class="k">return</span> <span class="p">[</span>
            <span class="n">cdf_truncnorm</span><span class="p">(</span>
                <span class="n">transform_fit</span><span class="p">(</span><span class="n">new_delT_10</span><span class="p">,</span>
                                <span class="n">mintemp</span><span class="p">,</span>
                                <span class="n">maxtemp</span><span class="p">),</span>
                <span class="n">mu_norm</span> <span class="o">+</span> <span class="n">mu_s</span><span class="p">,</span>
                <span class="n">sig_norm</span> <span class="o">+</span> <span class="n">sig_s</span><span class="p">,</span>
                <span class="n">S_m1</span><span class="p">,</span>
                <span class="n">S_1</span><span class="p">)</span> <span class="o">+</span> <span class="n">S10</span>
            <span class="p">,</span>
            <span class="n">cdf_truncnorm</span><span class="p">(</span>
                <span class="n">transform_fit</span><span class="p">(</span><span class="n">new_delT_50</span><span class="p">,</span>
                                    <span class="n">mintemp</span><span class="p">,</span>
                                    <span class="n">maxtemp</span><span class="p">),</span>
                <span class="n">mu_norm</span> <span class="o">+</span> <span class="n">mu_s</span><span class="p">,</span>
                <span class="n">sig_norm</span> <span class="o">+</span> <span class="n">sig_s</span><span class="p">,</span>
                <span class="n">S_m1</span><span class="p">,</span>
                <span class="n">S_1</span><span class="p">)</span> <span class="o">+</span> <span class="n">S50</span><span class="p">]</span>
    
        <span class="n">mu_guess</span> <span class="o">=</span> <span class="n">transform_fit</span><span class="p">(</span><span class="n">new_delT_10</span><span class="p">,</span><span class="n">mintemp</span><span class="p">,</span><span class="n">maxtemp</span><span class="p">)</span> <span class="o">-</span> <span class="n">transform_fit</span><span class="p">(</span>
            <span class="n">delTmax10_hwm</span><span class="p">,</span><span class="n">mintemp</span><span class="p">,</span><span class="n">maxtemp</span><span class="p">)</span>
        
        <span class="n">npar</span><span class="p">,</span> <span class="n">infodict_s</span><span class="p">,</span> <span class="n">ier_s</span><span class="p">,</span> <span class="n">mesg_s</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">F10_50_S</span><span class="p">,</span> <span class="p">(</span><span class="n">mu_guess</span><span class="p">,</span><span class="mf">0.0</span><span class="p">),</span><span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ier_s</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The solution for change in mean and standard deviation did not converge!&quot;</span><span class="p">)</span>
        
        <span class="n">del_mu_delT_max_hwm</span> <span class="o">=</span> <span class="n">npar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">del_sig_delT_max_hwm</span> <span class="o">=</span> <span class="n">npar</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># delta from -1...1 boundaries of the original transformed delT_max distribution.</span>
        <span class="n">del_a_delT_max_hwm</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">del_mu_delT_max_hwm</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">mu_norm</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sig_norm</span><span class="p">)</span> <span class="o">*</span> <span class="n">del_sig_delT_max_hwm</span>
        <span class="n">del_b_delT_max_hwm</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">del_mu_delT_max_hwm</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">mu_norm</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sig_norm</span><span class="p">)</span> <span class="o">*</span> <span class="n">del_sig_delT_max_hwm</span>
        
        <span class="c1"># adjusted durations - assume durations increase proportionally with </span>
        <span class="c1"># temperature.</span>
        <span class="n">S_D_10</span> <span class="o">=</span> <span class="n">new_delT_10</span> <span class="o">/</span> <span class="n">delTmax10_hwm</span>
        <span class="k">if</span> <span class="n">S_D_10</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A decrease in 10 year durations is not expected for the current analysis!&quot;</span><span class="p">)</span>
        <span class="n">S_D_50</span> <span class="o">=</span> <span class="n">new_delT_50</span> <span class="o">/</span> <span class="n">delTmax50_hwm</span>
        <span class="k">if</span> <span class="n">S_D_50</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A decrease in 50 year durations is not expected for the current analysis!&quot;</span><span class="p">)</span>
        
        <span class="n">D10_prime</span> <span class="o">=</span> <span class="n">D10</span> <span class="o">*</span> <span class="n">S_D_10</span>
        <span class="n">D50_prime</span> <span class="o">=</span> <span class="n">D50</span> <span class="o">*</span> <span class="n">S_D_50</span>
        
        <span class="n">P_prime_hwsm</span> <span class="o">=</span> <span class="p">(</span><span class="n">N10</span> <span class="o">*</span> <span class="n">Phwsm</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">S_D_50</span><span class="p">)</span> <span class="o">+</span> <span class="n">N50</span> <span class="o">*</span> <span class="n">Phwsm</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">S_D_10</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">N10</span> <span class="o">+</span> <span class="n">N50</span><span class="p">)</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1.0e-6</span>
        <span class="k">if</span> <span class="n">P_prime_hwsm</span><span class="o">+</span><span class="n">epsilon</span> <span class="o">&lt;</span> <span class="n">Phwsm</span><span class="p">:</span>
            <span class="n">pdb</span><span class="p">;</span><span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The probability of sustaining a heat wave has decreased. &quot;</span><span class="o">+</span>
                             <span class="s2">&quot;This should not happen in the current analysis!&quot;</span><span class="p">)</span>
        
        <span class="c1"># equation 30 optimal scaling of D_HW_Pm</span>
        <span class="n">S_D_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Phwsm</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">P_prime_hwsm</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">S_D_m</span> <span class="o">+</span> <span class="n">epsilon</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The scaling factor on heat wave sustainment&quot;</span><span class="o">+</span>
                             <span class="s2">&quot; must be greater than 1.0&quot;</span><span class="p">)</span>
        
        <span class="c1"># equation 31 scaling of energy</span>
        <span class="n">S_E_m</span> <span class="o">=</span> <span class="n">S_D_m</span> <span class="o">*</span> <span class="p">(</span><span class="n">new_delT_10</span><span class="o">/</span><span class="n">delTmax10_hwm</span> <span class="o">+</span> <span class="n">new_delT_50</span><span class="o">/</span><span class="n">delTmax50_hwm</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

        <span class="n">del_mu_E_hw_m</span> <span class="o">=</span> <span class="n">transform_fit</span><span class="p">(</span>
            <span class="n">S_E_m</span> <span class="o">*</span> <span class="n">inverse_transform_fit</span><span class="p">(</span>
                <span class="n">normalized_energy</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">],</span> 
                <span class="n">hot_param</span><span class="p">[</span><span class="s1">&#39;max energy per duration&#39;</span><span class="p">],</span> 
                <span class="n">hot_param</span><span class="p">[</span><span class="s1">&#39;min energy per duration&#39;</span><span class="p">])</span>
            <span class="p">,</span><span class="n">hot_param</span><span class="p">[</span><span class="s1">&#39;min energy per duration&#39;</span><span class="p">],</span>
             <span class="n">hot_param</span><span class="p">[</span><span class="s1">&#39;max energy per duration&#39;</span><span class="p">])</span><span class="o">-</span><span class="n">normalized_energy</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">]</span>     
        <span class="c1"># transformation is not needed here, </span>
        <span class="c1"># be careful here! inverse transform and transform have different </span>
        <span class="c1"># orders for the min and max inputs!</span>
        <span class="n">del_sig_E_hw_m</span> <span class="o">=</span> <span class="n">transform_fit</span><span class="p">(</span>
            <span class="p">(</span><span class="n">inverse_transform_fit</span><span class="p">(</span>
                <span class="n">normalized_ext_temp</span><span class="p">[</span><span class="s1">&#39;sig&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">del_sig_delT_max_hwm</span><span class="p">,</span> 
                <span class="n">maxtemp</span><span class="p">,</span> 
                <span class="n">mintemp</span><span class="p">)</span><span class="o">/</span>
              <span class="n">inverse_transform_fit</span><span class="p">(</span><span class="n">normalized_ext_temp</span><span class="p">[</span><span class="s1">&#39;sig&#39;</span><span class="p">],</span>
                                          <span class="n">maxtemp</span><span class="p">,</span> 
                                          <span class="n">mintemp</span><span class="p">))</span><span class="o">*</span>
              <span class="n">inverse_transform_fit</span><span class="p">(</span><span class="n">normalized_energy</span><span class="p">[</span><span class="s1">&#39;sig&#39;</span><span class="p">],</span> 
                                          <span class="n">hot_param</span><span class="p">[</span><span class="s1">&#39;max energy per duration&#39;</span><span class="p">],</span>
                                          <span class="n">hot_param</span><span class="p">[</span><span class="s1">&#39;min energy per duration&#39;</span><span class="p">]),</span>
              <span class="n">hot_param</span><span class="p">[</span><span class="s1">&#39;min energy per duration&#39;</span><span class="p">],</span>
              <span class="n">hot_param</span><span class="p">[</span><span class="s1">&#39;max energy per duration&#39;</span><span class="p">])</span><span class="o">-</span><span class="n">normalized_energy</span><span class="p">[</span><span class="s1">&#39;sig&#39;</span><span class="p">]</span>
        
        <span class="c1"># delta from the -1..1 boundaries of the transformed Energy distribution (still in transformed space but no </span>
        <span class="c1"># longer on the -1...1 interval.)</span>
        <span class="n">del_a_E_hw_m</span> <span class="o">=</span> <span class="n">del_mu_E_hw_m</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">normalized_energy</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">normalized_energy</span><span class="p">[</span><span class="s1">&#39;sig&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">del_sig_E_hw_m</span>
        <span class="n">del_b_E_hw_m</span> <span class="o">=</span> <span class="n">del_mu_E_hw_m</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">normalized_energy</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">normalized_energy</span><span class="p">[</span><span class="s1">&#39;sig&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">del_sig_E_hw_m</span>
        
        <span class="c1"># for the current work, assume cold snaps do not change with climate</span>
        <span class="c1"># TODO - add cold snap changes (decreases?)</span>
        <span class="n">P_prime_csm</span> <span class="o">=</span> <span class="n">Pcsm</span>
        <span class="n">P_prime_cssm</span> <span class="o">=</span> <span class="n">Pcssm</span>
        
        <span class="c1"># NEXT STEPS - GATHER ALL YOUR VARIABLES AND FORMULATE THE DELTA M matrix</span>
        <span class="c1"># RETURN THEM SO YOU CAN GET THEM INTO MEWS&#39; original EXTREMES class.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transition_matrix_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">Phwm</span> <span class="o">+</span> <span class="n">Pcsm</span> <span class="o">-</span> <span class="n">P_prime_hwm</span> <span class="o">-</span> <span class="n">P_prime_csm</span><span class="p">,</span> <span class="n">P_prime_csm</span> <span class="o">-</span> <span class="n">Pcsm</span><span class="p">,</span> <span class="n">P_prime_hwm</span> <span class="o">-</span> <span class="n">Phwm</span><span class="p">],</span>
             <span class="p">[</span><span class="n">Pcssm</span> <span class="o">-</span> <span class="n">P_prime_cssm</span><span class="p">,</span> <span class="n">P_prime_cssm</span> <span class="o">-</span> <span class="n">Pcssm</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
             <span class="p">[</span><span class="n">Phwsm</span> <span class="o">-</span> <span class="n">P_prime_hwsm</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">P_prime_hwsm</span> <span class="o">-</span> <span class="n">Phwsm</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">del_E_dist</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;del_mu&#39;</span><span class="p">:</span><span class="n">del_mu_E_hw_m</span><span class="p">,</span>
                 <span class="s1">&#39;del_sig&#39;</span><span class="p">:</span><span class="n">del_sig_E_hw_m</span><span class="p">,</span>
                 <span class="s1">&#39;del_a&#39;</span><span class="p">:</span><span class="n">del_a_E_hw_m</span><span class="p">,</span>
                 <span class="s1">&#39;del_b&#39;</span><span class="p">:</span><span class="n">del_b_E_hw_m</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">del_delTmax_dist</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;del_mu&#39;</span><span class="p">:</span><span class="n">del_mu_delT_max_hwm</span><span class="p">,</span>
                 <span class="s1">&#39;del_sig&#39;</span><span class="p">:</span><span class="n">del_sig_delT_max_hwm</span><span class="p">,</span>
                 <span class="s1">&#39;del_a&#39;</span><span class="p">:</span><span class="n">del_a_delT_max_hwm</span><span class="p">,</span>
                 <span class="s1">&#39;del_b&#39;</span><span class="p">:</span><span class="n">del_b_delT_max_hwm</span><span class="p">}</span>
        
    <span class="k">def</span> <span class="nf">_interpolate_ipcc_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ipcc_data</span><span class="p">,</span><span class="n">delta_TG</span><span class="p">):</span>
        
        <span class="c1"># this function is dependent on the format of the table in IPCC_FigureSPM_6.csv</span>
        
        <span class="n">present_tempanomal</span> <span class="o">=</span> <span class="n">ipcc_data</span><span class="p">[</span><span class="s1">&#39;Global Warming Levels (⁰C)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">future_tempanomal</span> <span class="o">=</span> <span class="n">present_tempanomal</span> <span class="o">+</span> <span class="n">delta_TG</span>
        
        <span class="k">if</span> <span class="n">future_tempanomal</span> <span class="o">&gt;</span> <span class="mf">4.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The current IPCC data only includes changes in temperature of 4C for global warming!&quot;</span><span class="p">)</span>
        
        <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">future_tempanomal</span> <span class="o">&lt;=</span> <span class="n">ipcc_data</span><span class="p">[</span><span class="s1">&#39;Global Warming Levels (⁰C)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ind</span><span class="p">]:</span>
                <span class="k">break</span>
            
        <span class="n">ipcc_num</span> <span class="o">=</span> <span class="n">ipcc_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;Event&quot;</span><span class="p">,</span><span class="s2">&quot;Units&quot;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">ind</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">interp_fact</span> <span class="o">=</span> <span class="p">(</span><span class="n">future_tempanomal</span> <span class="o">-</span> 
               <span class="n">ipcc_data</span><span class="p">[</span><span class="s1">&#39;Global Warming Levels (⁰C)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ind</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span>
               <span class="n">ipcc_data</span><span class="p">[</span><span class="s1">&#39;Global Warming Levels (⁰C)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">-</span> 
               <span class="n">ipcc_data</span><span class="p">[</span><span class="s1">&#39;Global Warming Levels (⁰C)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ind</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
             
               
                 
            <span class="n">ipcc_val_10_u</span> <span class="o">=</span> <span class="p">(</span><span class="n">ipcc_num</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">ipcc_num</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span> <span class="o">*</span> <span class="n">interp_fact</span> <span class="o">+</span> <span class="n">ipcc_num</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>
            <span class="n">ipcc_val_50_u</span> <span class="o">=</span> <span class="p">(</span><span class="n">ipcc_num</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">4</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">ipcc_num</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">3</span><span class="p">,:])</span> <span class="o">*</span> <span class="n">interp_fact</span> <span class="o">+</span> <span class="n">ipcc_num</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">3</span><span class="p">,:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ipcc_val_10_u</span> <span class="o">=</span> <span class="n">ipcc_num</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
            <span class="n">ipcc_val_50_u</span> <span class="o">=</span> <span class="n">ipcc_num</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">4</span><span class="p">,:]</span>
        
        <span class="c1"># TODO - if less recent data is available, this (Below) assumption</span>
        <span class="c1"># is non-conversative and will underestimate shifts in climate.</span>
        
        <span class="c1"># Assumption: Because, these values are being based off of data that is more recent,</span>
        <span class="c1"># the amplification/offset has to be based on current 1.0C warming levels.</span>
        
        
        
        
        <span class="n">ipcc_val_10</span> <span class="o">=</span> <span class="n">ipcc_val_10_u</span>
        <span class="n">ipcc_val_50</span> <span class="o">=</span> <span class="n">ipcc_val_50_u</span>
        
        <span class="k">for</span> <span class="n">lab</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">ipcc_val_10_u</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;Intensity&quot;</span> <span class="ow">in</span> <span class="n">lab</span><span class="p">:</span>
                <span class="n">ipcc_val_10</span><span class="p">[</span><span class="n">lab</span><span class="p">]</span> <span class="o">=</span> <span class="n">ipcc_val_10_u</span><span class="p">[</span><span class="n">lab</span><span class="p">]</span> <span class="o">-</span> <span class="n">ipcc_num</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">lab</span><span class="p">]</span>
                <span class="n">ipcc_val_50</span><span class="p">[</span><span class="n">lab</span><span class="p">]</span> <span class="o">=</span> <span class="n">ipcc_val_50_u</span><span class="p">[</span><span class="n">lab</span><span class="p">]</span> <span class="o">-</span> <span class="n">ipcc_num</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">lab</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s2">&quot;Frequency&quot;</span> <span class="ow">in</span> <span class="n">lab</span><span class="p">:</span>
                <span class="n">ipcc_val_10</span><span class="p">[</span><span class="n">lab</span><span class="p">]</span> <span class="o">=</span> <span class="n">ipcc_val_10_u</span><span class="p">[</span><span class="n">lab</span><span class="p">]</span> <span class="o">/</span> <span class="n">ipcc_num</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">lab</span><span class="p">]</span>
                <span class="n">ipcc_val_50</span><span class="p">[</span><span class="n">lab</span><span class="p">]</span> <span class="o">=</span> <span class="n">ipcc_val_50_u</span><span class="p">[</span><span class="n">lab</span><span class="p">]</span> <span class="o">/</span> <span class="n">ipcc_num</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">lab</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">ipcc_val_10</span><span class="p">,</span> <span class="n">ipcc_val_50</span>    </div>
    
    <span class="c1"># this is the same as the function for ExtremeTemperatureWaves but with</span>
    <span class="c1"># min and max as inputs</span>
    

<div class="viewcode-block" id="ClimateScenario"><a class="viewcode-back" href="../../../mews.events.extreme_temperature_waves.html#mews.events.extreme_temperature_waves.ClimateScenario">[docs]</a><span class="k">class</span> <span class="nc">ClimateScenario</span><span class="p">():</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_temp_anomaly</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_dir</span><span class="p">,</span><span class="s2">&quot;data&quot;</span><span class="p">,</span><span class="s2">&quot;IPCC2021_ThePhysicalBasis_TechnicalSummaryFigSPM8.csv&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># last column is the R2 value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scenarios</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$t^3$&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;$t^2$&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;$t$&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;$1$&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;$R^2$&#39;</span><span class="p">]</span>
        
<div class="viewcode-block" id="ClimateScenario.calculate_coef"><a class="viewcode-back" href="../../../mews.events.extreme_temperature_waves.html#mews.events.extreme_temperature_waves.ClimateScenario.calculate_coef">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_coef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scenario</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_temp_anomaly</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_temp_anomaly</span><span class="p">[</span><span class="s2">&quot;Climate Scenario&quot;</span><span class="p">]</span><span class="o">==</span><span class="n">scenario</span><span class="p">]</span>
        
        <span class="n">Xi</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Year&quot;</span><span class="p">]</span><span class="o">-</span><span class="mi">2020</span><span class="p">)</span><span class="o">/</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="c1"># 1.0 is the amount of heating assumed from 1850-1900 to 2020.</span>
        <span class="n">Yi</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Temperature Anomaly degC (baseline 1850-1900)&quot;</span><span class="p">]</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        
        <span class="n">p_coef</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">singular_values</span><span class="p">,</span> <span class="n">rcond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">Xi</span><span class="p">,</span><span class="n">Yi</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_coef</span> <span class="o">=</span> <span class="n">p_coef</span>
        
        <span class="n">SSres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Yi</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">p_coef</span><span class="p">,</span><span class="n">Xi</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">SStot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Yi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Yi</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">R2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">SSres</span><span class="o">/</span><span class="n">SStot</span><span class="p">)])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">p_coef</span><span class="p">,</span> <span class="n">R2</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scenarios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span></div>

    <span class="c1"># 0.267015 shifts to make the baseline year 2020 we assume a 1.0C affect </span>
<div class="viewcode-block" id="ClimateScenario.climate_temp_func"><a class="viewcode-back" href="../../../mews.events.extreme_temperature_waves.html#mews.events.extreme_temperature_waves.ClimateScenario.climate_temp_func">[docs]</a>    <span class="k">def</span> <span class="nf">climate_temp_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">year</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_coef</span><span class="p">,(</span><span class="n">year</span><span class="o">-</span><span class="mi">2020</span><span class="p">)</span><span class="o">/</span><span class="mi">50</span><span class="p">)</span><span class="o">-</span><span class="mf">0.267015</span></div>
    
<div class="viewcode-block" id="ClimateScenario.write_coef_to_table"><a class="viewcode-back" href="../../../mews.events.extreme_temperature_waves.html#mews.events.extreme_temperature_waves.ClimateScenario.write_coef_to_table">[docs]</a>    <span class="k">def</span> <span class="nf">write_coef_to_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">table_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">,</span>
                                <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scenarios</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">table_df</span><span class="o">.</span><span class="n">to_latex</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;C:\Users\dlvilla\Documents\BuildingEnergyModeling\MEWS\mews_temp\SimbuildPaper\from_python\cubic_coef_table.tex&quot;</span><span class="p">,</span>
                          <span class="n">float_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.6G</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">escape</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div></div>
        
    
    
        
            
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, National Technology and Engineering Solutions of Sandia, LLC.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>