<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mews.stats.extreme &mdash; MEWS 0.1 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> MEWS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MEWS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>mews.stats.extreme</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mews.stats.extreme</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Mon Apr 26 15:22:19 2021</span>

<span class="sd">Copyright Notice</span>
<span class="sd">=================</span>

<span class="sd">Copyright 2021 National Technology and Engineering Solutions of Sandia, LLC. </span>
<span class="sd">Under the terms of Contract DE-NA0003525, there is a non-exclusive license </span>
<span class="sd">for use of this work by or on behalf of the U.S. Government. </span>
<span class="sd">Export of this program may require a license from the </span>
<span class="sd">United States Government.</span>

<span class="sd">Please refer to the LICENSE.md file for a full description of the license</span>
<span class="sd">terms for MEWS. </span>

<span class="sd">The license for MEWS is the Modified BSD License and copyright information</span>
<span class="sd">must be replicated in any derivative works that use the source code.</span>


<span class="sd">@author: dlvilla</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">mews.weather</span> <span class="kn">import</span> <span class="n">Alter</span>
<span class="kn">from</span> <span class="nn">mews.cython.markov</span> <span class="kn">import</span> <span class="n">markov_chain</span>
<span class="kn">from</span> <span class="nn">mews.stats.markov</span> <span class="kn">import</span> <span class="n">MarkovPy</span>
<span class="kn">from</span> <span class="nn">mews.errors.exceptions</span> <span class="kn">import</span> <span class="n">ExtremesIntegrationError</span>
<span class="kn">from</span> <span class="nn">numpy.random</span>  <span class="kn">import</span> <span class="n">default_rng</span><span class="p">,</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span><span class="p">,</span> <span class="n">minimize</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<div class="viewcode-block" id="DiscreteMarkov"><a class="viewcode-back" href="../../../mews.stats.extreme.html#mews.stats.extreme.DiscreteMarkov">[docs]</a><span class="k">class</span> <span class="nc">DiscreteMarkov</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; obj = MarkovChain(transition_matrix,</span>
<span class="sd">                          state_names,</span>
<span class="sd">                          use_cython=True)</span>
<span class="sd">    </span>
<span class="sd">    Object to work with discrete Markov chains.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rng : numpy.random.default_rng()</span>
<span class="sd">        Random number generator</span>
<span class="sd">        </span>
<span class="sd">    transition_matrix : np.ndarray of np.float</span>
<span class="sd">        Square matrix that is a right stochastic matrix (i.e. the rows </span>
<span class="sd">        sum to 1).</span>
<span class="sd">        </span>
<span class="sd">    state_names : list of strings : optional : Default = None</span>
<span class="sd">        list of names that must be of the same dimension as the dimension</span>
<span class="sd">        as the transition_matrix. The default is None and a list of </span>
<span class="sd">        [&quot;0&quot;,&quot;1&quot;,...] is assigned.</span>
<span class="sd">        </span>
<span class="sd">    use_cython : bool : optional : Default = True</span>
<span class="sd">        Use cython to calculate markov chain histories (~20x faster). </span>
<span class="sd">        The default is True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rng</span><span class="p">,</span><span class="n">transition_matrix</span><span class="p">,</span><span class="n">state_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">use_cython</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span>
        <span class="c1"># special handling</span>
        <span class="k">if</span> <span class="n">state_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">state_names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">transition_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Something is wrong with the transition_matrix&quot;</span>
                                <span class="o">+</span><span class="s2">&quot;. It must be a right stochastic&quot;</span>
                                <span class="o">+</span><span class="s2">&quot; square matrix!&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">use_cython</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The use_cython input must be a boolean!&quot;</span><span class="p">)</span>
        <span class="c1"># type and value checks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type_checks</span><span class="p">(</span><span class="n">transition_matrix</span><span class="p">,</span> <span class="n">state_names</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value_checks</span><span class="p">(</span><span class="n">state_names</span><span class="p">,</span><span class="n">transition_matrix</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_mat</span> <span class="o">=</span> <span class="n">transition_matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cdf</span> <span class="o">=</span> <span class="n">transition_matrix</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state_names</span><span class="p">):</span>
            <span class="n">names</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_names</span> <span class="o">=</span> <span class="n">names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_cython</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-10</span>
        
<div class="viewcode-block" id="DiscreteMarkov.history"><a class="viewcode-back" href="../../../mews.stats.extreme.html#mews.stats.extreme.DiscreteMarkov.history">[docs]</a>    <span class="k">def</span> <span class="nf">history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">num_step</span><span class="p">,</span><span class="n">state0</span><span class="p">,</span><span class="n">min_steps</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span><span class="n">skip_steps</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">count_in_min_steps_intervals</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &gt;&gt;&gt; obj.history(num_step,state0, </span>
<span class="sd">                        min_steps, </span>
<span class="sd">                        skip_steps)</span>
<span class="sd">        </span>
<span class="sd">        Calculate a history for a discrete markov chain of &#39;num_step&#39; length</span>
<span class="sd">        and initial &#39;state0&#39;.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        num_step : int or np.int</span>
<span class="sd">            Number of steps to simulate for the object&#39;s defined transition_matrix.</span>
<span class="sd">        state0 : int or str</span>
<span class="sd">            Initial state of the history.</span>
<span class="sd">        min_steps : int : optional</span>
<span class="sd">            Minimum number of steps before a state can transition.</span>
<span class="sd">        skip_steps : int</span>
<span class="sd">            Number of steps at the beginning of the markov chain to assign to</span>
<span class="sd">            state0 (this is used for weather files that may begin in the middle</span>
<span class="sd">            of the day to avoid applying heat waves out of sync with</span>
<span class="sd">            day-night cycles).</span>
<span class="sd">        count_in_min_steps_intervals : bool : optional : Default = True</span>
<span class="sd">            True = apply markov transition matrix as a discrete process that </span>
<span class="sd">            is randomly tested every min_steps interval (i.e. min_steps = 24</span>
<span class="sd">            means the markov chain state is only tested 1 in 24 steps).</span>
<span class="sd">            False = apply markov transition matrix every step but only transition</span>
<span class="sd">            at every min_steps step.</span>
<span class="sd">            </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Error in input for num_step or state0. State0 must be a value less</span>
<span class="sd">            than the dimension-1 of the transition_matrix or a string that is </span>
<span class="sd">            in the self._names dictionary.</span>
<span class="sd">        TypeError</span>
<span class="sd">            All incorrect types are rejected from this method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">state0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_names</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;state0&#39; input must be a valid state_name=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_names</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># convert to an index</span>
                <span class="n">state0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_names</span><span class="p">[</span><span class="n">state0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state0</span><span class="p">,(</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span><span class="nb">int</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The &#39;state0&#39; input must be a valid string name or an integer!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nxn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_names</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">state0</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_names</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The transition_matrix is </span><span class="si">{0:d}</span><span class="s2">x</span><span class="si">{1:d}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nxn</span><span class="p">,</span><span class="n">nxn</span><span class="p">)</span>
                                 <span class="o">+</span><span class="s2">&quot;but a state = </span><span class="si">{2:d}</span><span class="s2"> was entered&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">count_in_min_steps_intervals</span><span class="p">:</span> 
            <span class="n">num_real_step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">num_step</span> <span class="o">-</span> <span class="n">skip_steps</span><span class="p">)</span><span class="o">/</span><span class="n">min_steps</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_real_step</span> <span class="o">=</span> <span class="n">num_step</span>
        
        <span class="k">if</span> <span class="n">num_real_step</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The number of skip_steps must not be greater than the num_steps!&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">num_real_step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There are no real steps. The weather history&quot;</span>
                             <span class="o">+</span><span class="s2">&quot; provided is too short to sample in min_steps&quot;</span>
                             <span class="o">+</span><span class="s2">&quot;=</span><span class="si">{0:d}</span><span class="s2"> size steps!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_steps</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">count_in_min_steps_intervals</span><span class="p">:</span>
            <span class="n">remain_steps</span> <span class="o">=</span> <span class="n">num_step</span> <span class="o">-</span> <span class="n">num_real_step</span> <span class="o">*</span> <span class="n">min_steps</span> <span class="o">-</span> <span class="n">skip_steps</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remain_steps</span> <span class="o">=</span> <span class="mi">0</span>
            
        <span class="n">prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">num_real_step</span><span class="p">)</span>
        
        <span class="n">cdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cdf</span>
        <span class="c1"># The Markov Chain is NOT efficient in Python </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_cython</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">markov_chain</span><span class="p">(</span><span class="n">cdf</span><span class="p">,</span><span class="n">prob</span><span class="p">,</span><span class="n">state0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">MarkovPy</span><span class="o">.</span><span class="n">markov_chain_py</span><span class="p">(</span><span class="n">cdf</span><span class="p">,</span><span class="n">prob</span><span class="p">,</span><span class="n">state0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">count_in_min_steps_intervals</span><span class="p">:</span>
            <span class="c1"># translate state into an array of min_step length segments</span>
            <span class="n">state_extended</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="n">min_steps</span><span class="p">)</span>
            <span class="n">ending_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">state_extended</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]),</span><span class="n">remain_steps</span><span class="p">)</span>
            <span class="n">begin_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">state0</span><span class="p">]),</span><span class="n">skip_steps</span><span class="p">)</span>
            
            <span class="n">final_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">begin_state</span><span class="p">,</span><span class="n">state_extended</span><span class="p">,</span><span class="n">ending_state</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO - this is slow!</span>
            <span class="c1"># move state changes to min_step intervals</span>
            <span class="c1"># for each day, assign the state that has the majority of hours in</span>
            <span class="c1"># the day.</span>
            

            <span class="n">big_step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">num_step</span><span class="o">/</span><span class="n">min_steps</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">big_step</span><span class="p">):</span>
                <span class="n">day</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">min_steps</span> <span class="o">*</span> <span class="n">idx</span><span class="p">:</span><span class="n">min_steps</span><span class="o">*</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
                <span class="n">state_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">day</span> <span class="o">==</span> <span class="n">state_val</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">state_val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_names</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
                <span class="n">state</span><span class="p">[</span><span class="n">min_steps</span> <span class="o">*</span> <span class="n">idx</span><span class="p">:</span><span class="n">min_steps</span><span class="o">*</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">state_count</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>

            <span class="n">final_state</span> <span class="o">=</span> <span class="n">state</span>
        
        <span class="k">return</span> <span class="n">final_state</span></div>
            
<div class="viewcode-block" id="DiscreteMarkov.steady"><a class="viewcode-back" href="../../../mews.stats.extreme.html#mews.stats.extreme.DiscreteMarkov.steady">[docs]</a>    <span class="k">def</span> <span class="nf">steady</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &gt;&gt;&gt; obj.steady()</span>
<span class="sd">        </span>
<span class="sd">        Calculates a stationary probability vector for each state based on the</span>
<span class="sd">        transition probability matrix.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        steady : np.ndarray</span>
<span class="sd">            Vector of stationary probabilities of each state given the </span>
<span class="sd">            transition matrix assigned to the process.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># transpose needed because eig must work with a left hand stochastic</span>
        <span class="c1"># matrix</span>
        <span class="n">val</span><span class="p">,</span><span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mat</span><span class="p">))</span>
        <span class="n">steady</span> <span class="o">=</span> <span class="n">vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">vec</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">steady</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">steady</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">UserWarning</span><span class="p">(</span><span class="s2">&quot;The eigenvector has non-zero imaginary parts!&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">steady</span><span class="p">)</span></div>
            
                
    <span class="k">def</span> <span class="nf">_type_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">transition_matrix</span><span class="p">,</span><span class="n">state_names</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state_names</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The &#39;state_names&#39; input must be a list&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">state_names</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The &#39;state_names&#39; elements must be strings!&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transition_matrix</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The &#39;transition_matrix&#39; input must be a numpy array!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">transition_matrix</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The &#39;transition_matrix&#39; must have elements that are numeric!&quot;</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">_value_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">state_names</span><span class="p">,</span><span class="n">transition_matrix</span><span class="p">):</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-6</span>
        <span class="k">if</span> <span class="n">transition_matrix</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;transition_matrix&#39; input must be of dimension=2!&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">transition_matrix</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All entries to the transition matrix are probabilities and must be positive!&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">state_names</span><span class="p">)</span> <span class="o">!=</span> <span class="n">transition_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The number of statenames must match the size of the transition_matrix!&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">transition_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">transition_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;transition_matrix&#39; input must be a square matrix!&quot;</span><span class="p">)</span>
        
        <span class="n">row_sum</span> <span class="o">=</span> <span class="n">transition_matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">row_sum</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="o">+</span><span class="n">epsilon</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">row_sum</span> <span class="o">&lt;</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">epsilon</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The rows of the transition matrix must sum to &quot;</span>
                             <span class="o">+</span> <span class="s2">&quot;one. At least one row is &quot;</span>
                             <span class="o">+</span><span class="s2">&quot;</span><span class="si">{0:5.3e}</span><span class="s2"> away from 1.0!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epsilon</span><span class="p">))</span>
        <span class="c1"># renormalize</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">rsum</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row_sum</span><span class="p">):</span>
            <span class="n">transition_matrix</span><span class="p">[</span><span class="n">idx</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">transition_matrix</span><span class="p">[</span><span class="n">idx</span><span class="p">,:]</span><span class="o">/</span><span class="n">rsum</span></div>
        

        

<span class="c1"># This is a preliminary class for the toy model. Much more thorough review of</span>
<span class="c1"># best methods for heat wave generation and of using historical data as a </span>
<span class="c1"># starting point for statistical distributions is needed.</span>
<div class="viewcode-block" id="Extremes"><a class="viewcode-back" href="../../../mews.stats.extreme.html#mews.stats.extreme.Extremes">[docs]</a><span class="k">class</span> <span class="nc">Extremes</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit weather data with a model for extreme hot and cold that can</span>
<span class="sd">    then be modified to produce increasing intensity and duration</span>
<span class="sd">    by adjustment of the statistical parameters involved.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; obj = Extremes(start_year,</span>
<span class="sd">                       max_avg_dist,</span>
<span class="sd">                       max_avg_delta,</span>
<span class="sd">                       min_avg_dist,</span>
<span class="sd">                       min_avg_delta,</span>
<span class="sd">                       transition_matrix,</span>
<span class="sd">                       transition_matrix_delta,</span>
<span class="sd">                       weather_files,</span>
<span class="sd">                       num_realizations,</span>
<span class="sd">                       num_repeat=1,</span>
<span class="sd">                       use_cython=True,</span>
<span class="sd">                       column=&#39;Dry Bulb Temperature&#39;,</span>
<span class="sd">                       tzname=None,</span>
<span class="sd">                       write_results=True,</span>
<span class="sd">                       results_folder=&quot;&quot;,</span>
<span class="sd">                       results_append_to_name=&quot;&quot;,</span>
<span class="sd">                       run_parallel=True,</span>
<span class="sd">                       min_steps=24,</span>
<span class="sd">                       test_shape_func=False,</span>
<span class="sd">                       doe2_input=None,</span>
<span class="sd">                       random_seed=None,</span>
<span class="sd">                       max_E_dist=None,</span>
<span class="sd">                       del_max_E_dist=None,</span>
<span class="sd">                       min_E_dist=None,</span>
<span class="sd">                       del_min_E_dist=None,</span>
<span class="sd">                       frac_long_wave=0.8,</span>
<span class="sd">                       current_year=None,</span>
<span class="sd">                       climate_temp_func=None,</span>
<span class="sd">                       averaging_steps=1,</span>
<span class="sd">                       no_climate_trend=False)</span>
<span class="sd">    </span>
<span class="sd">    look for results in obj.results - files are output as specified in the inputs.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start_year : int</span>
<span class="sd">        Year to begin a new history that will replace other years in </span>
<span class="sd">        weather files.</span>
<span class="sd">    </span>
<span class="sd">    max_avg_dist : function or dict</span>
<span class="sd">        If function: </span>
<span class="sd">            High extreme (for temperature extreme heat) statistical</span>
<span class="sd">            distribution function that returns random numbers that indicate</span>
<span class="sd">            how much energy/hr is associated with an extreme event.</span>
<span class="sd">        If dict: </span>
<span class="sd">            A dictionary of functions where each...</span>
<span class="sd">        </span>
<span class="sd">    max_avg_delta : float or dict</span>
<span class="sd">        If float:</span>
<span class="sd">            Gradient of change for the average value of </span>
<span class="sd">            max_avg_dist per year. Change is included step-wise on a yearly</span>
<span class="sd">            basis.</span>
<span class="sd">        If dict:</span>
<span class="sd">            Contains elements &#39;func&#39; and &#39;param&#39; where &#39;param&#39; is a dictionary</span>
<span class="sd">            of deltas on each parameter input to the function in &#39;func&#39;</span>
<span class="sd">            set of all monthly parameters needed by the max_avg_dist </span>
<span class="sd">            function. The number of parameters is distribution dependent.</span>
<span class="sd">        </span>
<span class="sd">    min_avg_dist : function or dict</span>
<span class="sd">        If function:</span>
<span class="sd">            A CDF that recieves one input.</span>
<span class="sd">            </span>
<span class="sd">            Low extreme (for temperature extreme cold) statistical distribution</span>
<span class="sd">            function that returns random numbers that indicate how much </span>
<span class="sd">            reduction in energy/hr is associated with an extreme event.</span>
<span class="sd">        </span>
<span class="sd">        If dict:</span>
<span class="sd">            ...</span>
<span class="sd">        </span>
<span class="sd">    min_avg_delta : float</span>
<span class="sd">        Gradient of change for the average value of min_avg_dist per year.</span>
<span class="sd">        Change is included step-wise on a yearly basis</span>
<span class="sd">        </span>
<span class="sd">    transition_matrix : np.array</span>
<span class="sd">        Markov chain 3x3 matrix where index 0 = probability of &quot;normal </span>
<span class="sd">        conditions&quot;, 1 = probability of maximum extreme conditions, and</span>
<span class="sd">        2 = probability of minimum extreme conditions. Rows number is associated</span>
<span class="sd">        with the probabilities for a given state (i.e. row 0 applies when the</span>
<span class="sd">        the current state is 0). Rows must sum to 1.</span>
<span class="sd">        </span>
<span class="sd">    transition_matrix_delta : np.array</span>
<span class="sd">        Rate per year that transition matrix probabilities are changing in</span>
<span class="sd">        absolute (not percentage) change in probability. Rows must sum to zero so that the</span>
<span class="sd">        transition matrix always has rows continue to sum to 1.</span>
<span class="sd">        </span>
<span class="sd">    weather_files : list </span>
<span class="sd">        Weather files that will be read and altered per the statistical specs above.</span>
<span class="sd">        </span>
<span class="sd">    num_realizations : int</span>
<span class="sd">        The number of realizations per weather file that will be output for the</span>
<span class="sd">        statistics. Number of output weather files is num_realizations * len(weather_files).</span>
<span class="sd">        </span>
<span class="sd">    num_repeat : int : optional : Default = 1</span>
<span class="sd">        Number of repeat years that will be processed into a longer duration</span>
<span class="sd">        than the original weather file.</span>
<span class="sd">        </span>
<span class="sd">    use_cython : bool : optional : Default = True</span>
<span class="sd">        Flag to enable cython. If False, then much slower native python</span>
<span class="sd">        is used for the Markov chain. </span>
<span class="sd">        </span>
<span class="sd">    column : str : optional : Default = &#39;Dry Bulb Temperature&#39;</span>
<span class="sd">        Column for weather signal that will be altered. This input needs</span>
<span class="sd">        to be different for a DOE2 weather file.</span>
<span class="sd">        </span>
<span class="sd">    tzname : str : optional : Default = None</span>
<span class="sd">        Time zone name to apply the weather files to. Must be a valid</span>
<span class="sd">        time zone for the tz Python library.</span>
<span class="sd">        </span>
<span class="sd">    write_results : bool : optional : Default = True</span>
<span class="sd">        Flag to either write (True) or not write the weather files.</span>
<span class="sd">        results can be accessed through obj.results if not written.</span>
<span class="sd">        </span>
<span class="sd">    results_folder : str : optional : Default = &quot;&quot;</span>
<span class="sd">        String of a path to a location to write weather files.</span>
<span class="sd">    </span>
<span class="sd">    results_append_to_name : str : optional : Default = &quot;&quot;</span>
<span class="sd">        String to append to the file names of output weather files.</span>
<span class="sd">        </span>
<span class="sd">    run_parallel : bool : optional : Default = True</span>
<span class="sd">        Flag to either run parallel (True) or run on a single processor (False)</span>
<span class="sd">        set to False if parallel run engine fails.</span>
<span class="sd">        </span>
<span class="sd">    min_steps : int &gt; 0 : optional : Default=24</span>
<span class="sd">        Minimum number of time steps for an extreme event .</span>
<span class="sd">        </span>
<span class="sd">    test_shape_func : bool : optional : Default = False</span>
<span class="sd">        For testing purposes:</span>
<span class="sd">            Boolean indicating whether computationally expensive testing is </span>
<span class="sd">            done to assure the shape function used integrates to the original</span>
<span class="sd">            heat_added. Default value is False - True is needed for unittesting.</span>
<span class="sd">        </span>
<span class="sd">    doe2_input : dict : optional : Default = None</span>
<span class="sd">       | Optional input required to perform the analysis using DOE2</span>
<span class="sd">       | bin files. See mews.weather.alter. needs:</span>
<span class="sd">       | {&#39;doe2_bin2txt_path&#39;:OPTIONAL - path to bin2txt.exe DOE2 utility</span>
<span class="sd">       | MEWS has a default location for this utility </span>
<span class="sd">       | which can be obtained from DOE2 (www.doe2.com),</span>
<span class="sd">       | &#39;doe2_start_datetime&#39;:datetime indicating the start date and time</span>
<span class="sd">       | for the weather DOE2 weather file,</span>
<span class="sd">       | &#39;doe2_tz&#39;=time zone for doe2 file,</span>
<span class="sd">       | &#39;doe2_hour_in_file&#39;=8760 or 8784 for leap year,</span>
<span class="sd">       | &#39;doe2_dst&#39;= Start and end of daylight savings time for the </span>
<span class="sd">       | doe2_start_datetime year,</span>
<span class="sd">       | &#39;txt2bin_exepath&#39; : OPTIONAL - path to txt2bin.exe DOE2 utility}</span>
<span class="sd">    </span>
<span class="sd">    random_seed : int : optional : Default = None</span>
<span class="sd">        Use this to fix an analysis so that pseudo-random numbers are sampled</span>
<span class="sd">        as the same sequence so that results can be replicated.</span>
<span class="sd">        </span>
<span class="sd">     max_E_dist : dict : optional : Default = None</span>
<span class="sd">         A distribution that defines random sampling for energy of an </span>
<span class="sd">         extreme wave. If this is None, then the old way of using</span>
<span class="sd">         Extreme applies if it is a dictionary, then it must be a CDF function</span>
<span class="sd">         that allows random numbers to be used and has parameters as independent</span>
<span class="sd">         inputs so that they can be shifted via the del_max_E_dist input.</span>
<span class="sd">         </span>
<span class="sd">    del_max_E_dist : dict : optional : Default = None</span>
<span class="sd">        For every parameter in max_E_dist, a del_param is needed that shows</span>
<span class="sd">        how the max_E_dist is stretched/shifted with changes in climate.</span>
<span class="sd">        </span>
<span class="sd">    frac_long_wave : float &lt;= 1 &gt; 0 </span>
<span class="sd">        Old input style feature. The amount of energy that goes into a sinusoidal peak. </span>
<span class="sd">        </span>
<span class="sd">    current_year : int : optional </span>
<span class="sd">        New input style feature. Used to add a global warming offset to the entire dataset.</span>
<span class="sd">    </span>

<span class="sd">     </span>
<span class="sd">     no_climate_trend : Bool : Optional : Default = False</span>
<span class="sd">          Exclude the climate trend gradual increase in temperature</span>
<span class="sd">          while including the heat wave effects.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO finish documentation</span>
<span class="sd">     ,</span>
<span class="sd">     min_E_dist=None - optional, cold snap analog to max_E_dist</span>
<span class="sd">     del_min_E_dist - optional, cold snap analog to del_max_E_dist</span>
<span class="sd">     climate_temp_func</span>
<span class="sd">     averaging_steps (see alter object)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">states</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;normal&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;cold&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;hot&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>
    <span class="n">max_recursion</span> <span class="o">=</span> <span class="mi">100</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">start_year</span><span class="p">,</span>
                 <span class="n">max_avg_dist</span><span class="p">,</span>
                 <span class="n">max_avg_delta</span><span class="p">,</span>
                 <span class="n">min_avg_dist</span><span class="p">,</span>
                 <span class="n">min_avg_delta</span><span class="p">,</span>
                 <span class="n">transition_matrix</span><span class="p">,</span>
                 <span class="n">transition_matrix_delta</span><span class="p">,</span>
                 <span class="n">weather_files</span><span class="p">,</span>
                 <span class="n">num_realizations</span><span class="p">,</span>
                 <span class="n">num_repeat</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">use_cython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">column</span><span class="o">=</span><span class="s1">&#39;Dry Bulb Temperature&#39;</span><span class="p">,</span>
                 <span class="n">tzname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">write_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">results_folder</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">results_append_to_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">run_parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">min_steps</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
                 <span class="n">test_shape_func</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">doe2_input</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">max_E_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">del_max_E_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">min_E_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">del_min_E_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">frac_long_wave</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                 <span class="n">current_year</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">climate_temp_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">averaging_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">no_climate_trend</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># perform some input checking</span>
        <span class="n">new_input_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monthly_input_checking</span><span class="p">([</span><span class="n">max_avg_dist</span><span class="p">,</span> 
                                      <span class="n">max_avg_delta</span><span class="p">,</span> 
                                      <span class="n">min_avg_dist</span><span class="p">,</span> 
                                      <span class="n">min_avg_delta</span><span class="p">,</span> 
                                      <span class="n">transition_matrix</span><span class="p">,</span> 
                                      <span class="n">transition_matrix_delta</span><span class="p">,</span> 
                                      <span class="n">max_E_dist</span><span class="p">,</span> 
                                      <span class="n">del_max_E_dist</span><span class="p">,</span> 
                                      <span class="n">min_E_dist</span><span class="p">,</span> 
                                      <span class="n">del_min_E_dist</span><span class="p">])</span>
        


        
        <span class="c1"># set the random seed - only for non-parallel application!</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">random_seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">()</span>
        
        <span class="c1"># turn off parallel for the DOE2 case or setup parallel processing otherwise.</span>
        <span class="k">if</span> <span class="n">run_parallel</span> <span class="ow">and</span> <span class="n">doe2_input</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
                <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Something went wrong with importing &quot;</span>
                            <span class="o">+</span><span class="s2">&quot;multiprocessing and creating a pool &quot;</span>
                            <span class="o">+</span><span class="s2">&quot;of asynchronous processes reverting to&quot;</span>
                            <span class="o">+</span><span class="s2">&quot; non-parallel run!&quot;</span><span class="p">,</span><span class="ne">UserWarning</span><span class="p">)</span>
                <span class="n">run_parallel</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">run_parallel</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">doe2_input</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">run_parallel</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The program does not handle DOE2 files with&quot;</span><span class="o">+</span>
                              <span class="s2">&quot; multiple processors run_parallel set to &#39;False&#39;&quot;</span><span class="p">,</span>
                              <span class="ne">UserWarning</span><span class="p">)</span>
        
        <span class="c1"># Constants that should not be changed.</span>
        <span class="n">state_int</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># no changes to non-selected intervals</span>
        <span class="n">state_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">num_wfile</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">weather_files</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recursive_depth</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">id0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_realizations</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_repeat</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">idy</span><span class="p">,</span><span class="n">wfile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">weather_files</span><span class="p">):</span>
                     
                    <span class="k">if</span> <span class="n">new_input_format</span><span class="p">:</span>
                        <span class="n">year</span> <span class="o">=</span> <span class="n">current_year</span>
                        
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">year</span> <span class="o">=</span> <span class="n">start_year</span> <span class="o">+</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">num_wfile</span> <span class="o">+</span> <span class="n">idy</span>
                        
                    <span class="n">key_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">wfile</span><span class="p">,</span> <span class="n">id0</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">run_parallel</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">random_seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">rng</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span> 
                            <span class="n">rng</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="p">(</span><span class="n">random_seed</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1010</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">))))</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_year</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">num_wfile</span><span class="p">,</span><span class="n">idy</span><span class="p">,</span><span class="n">wfile</span><span class="p">,</span><span class="n">column</span><span class="p">,</span>
                                <span class="n">tzname</span><span class="p">,</span><span class="n">transition_matrix</span><span class="p">,</span><span class="n">transition_matrix_delta</span><span class="p">,</span>
                                <span class="n">state_name</span><span class="p">,</span><span class="n">use_cython</span><span class="p">,</span><span class="n">state_int</span><span class="p">,</span> 
                                <span class="n">min_avg_dist</span><span class="p">,</span> <span class="n">min_avg_delta</span><span class="p">,</span> 
                                <span class="n">max_avg_dist</span><span class="p">,</span> <span class="n">max_avg_delta</span><span class="p">,</span> <span class="n">results_folder</span><span class="p">,</span> 
                                <span class="n">results_append_to_name</span><span class="p">,</span> <span class="n">id0</span><span class="p">,</span> <span class="n">write_results</span><span class="p">,</span><span class="n">year</span><span class="p">,</span>
                                <span class="n">frac_long_wave</span><span class="p">,</span><span class="n">min_steps</span><span class="p">,</span><span class="n">test_shape_func</span><span class="p">,</span><span class="n">doe2_input</span><span class="p">,</span>
                                <span class="n">max_E_dist</span><span class="p">,</span><span class="n">del_max_E_dist</span><span class="p">,</span><span class="n">min_E_dist</span><span class="p">,</span><span class="n">del_min_E_dist</span><span class="p">,</span>
                                <span class="n">new_input_format</span><span class="p">,</span><span class="n">climate_temp_func</span><span class="p">,</span><span class="n">averaging_steps</span><span class="p">,</span><span class="n">rng</span><span class="p">,</span><span class="n">no_climate_trend</span><span class="p">)</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">key_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_wfile</span><span class="p">,</span>
                                                         <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">key_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_wfile</span><span class="p">(</span><span class="n">start_year</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span>
                                <span class="n">num_wfile</span><span class="p">,</span><span class="n">idy</span><span class="p">,</span><span class="n">wfile</span><span class="p">,</span><span class="n">column</span><span class="p">,</span>
                                <span class="n">tzname</span><span class="p">,</span><span class="n">transition_matrix</span><span class="p">,</span><span class="n">transition_matrix_delta</span><span class="p">,</span>
                                <span class="n">state_name</span><span class="p">,</span><span class="n">use_cython</span><span class="p">,</span><span class="n">state_int</span><span class="p">,</span>
                                <span class="n">min_avg_dist</span><span class="p">,</span> <span class="n">min_avg_delta</span><span class="p">,</span> 
                                <span class="n">max_avg_dist</span><span class="p">,</span> <span class="n">max_avg_delta</span><span class="p">,</span> <span class="n">results_folder</span><span class="p">,</span> 
                                <span class="n">results_append_to_name</span><span class="p">,</span> <span class="n">id0</span><span class="p">,</span> <span class="n">write_results</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span>
                                <span class="n">frac_long_wave</span><span class="p">,</span><span class="n">min_steps</span><span class="p">,</span><span class="n">test_shape_func</span><span class="p">,</span><span class="n">doe2_input</span><span class="p">,</span>
                                <span class="n">max_E_dist</span><span class="p">,</span><span class="n">del_max_E_dist</span><span class="p">,</span><span class="n">min_E_dist</span><span class="p">,</span><span class="n">del_min_E_dist</span><span class="p">,</span>
                                <span class="n">new_input_format</span><span class="p">,</span><span class="n">climate_temp_func</span><span class="p">,</span><span class="n">averaging_steps</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span><span class="n">no_climate_trend</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">run_parallel</span><span class="p">:</span>
            <span class="n">results_get</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">tup</span><span class="p">,</span><span class="n">poolObj</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">results_get</span><span class="p">[</span><span class="n">tup</span><span class="p">]</span> <span class="o">=</span> <span class="n">poolObj</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;The multiprocessing module will not&quot;</span>
                                         <span class="o">+</span><span class="s2">&quot; handle lambda functions or any&quot;</span>
                                         <span class="o">+</span><span class="s2">&quot; other locally defined functions!&quot;</span><span class="p">)</span>
               
            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">results_get</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">results</span>
    
    <span class="k">def</span> <span class="nf">_monthly_input_checking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dict_list</span><span class="p">):</span>
        <span class="n">incorrect_type</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dict_found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">dict_e</span> <span class="ow">in</span> <span class="n">dict_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dict_e</span><span class="p">,</span><span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dict_e</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">incorrect_type</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dict_e</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dict_found</span><span class="o">=</span><span class="kc">True</span>
                    <span class="k">if</span> <span class="s1">&#39;func&#39;</span> <span class="ow">in</span> <span class="n">dict_e</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">dict_e2</span> <span class="o">=</span> <span class="n">dict_e</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dict_e2</span> <span class="o">=</span> <span class="n">dict_e</span>
                    
                    <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">dict_e2</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All dictionary inputs must have an entry for every month!&quot;</span><span class="p">)</span>
        
        
        <span class="k">if</span> <span class="n">incorrect_type</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">incorrect_type</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;You must either define all inputs as dictionaires&quot;</span>
                            <span class="o">+</span><span class="s2">&quot; with 12 months as the key {1:,2:, etc..} or as&quot;</span>
                            <span class="o">+</span><span class="s2">&quot; functions and floats per the documentation&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">dict_found</span>
            
    
    <span class="c1"># this function was created to make parallelization possible.</span>
    <span class="k">def</span> <span class="nf">_process_wfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">start_year</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">num_wfile</span><span class="p">,</span><span class="n">idy</span><span class="p">,</span><span class="n">wfile</span><span class="p">,</span><span class="n">column</span><span class="p">,</span><span class="n">tzname</span><span class="p">,</span>
                       <span class="n">transition_matrix</span><span class="p">,</span><span class="n">transition_matrix_delta</span><span class="p">,</span><span class="n">state_name</span><span class="p">,</span>
                       <span class="n">use_cython</span><span class="p">,</span><span class="n">state_int</span><span class="p">,</span><span class="n">min_avg_dist</span><span class="p">,</span>
                       <span class="n">min_avg_delta</span><span class="p">,</span><span class="n">max_avg_dist</span><span class="p">,</span><span class="n">max_avg_delta</span><span class="p">,</span>
                       <span class="n">results_folder</span><span class="p">,</span> <span class="n">results_append_to_name</span><span class="p">,</span><span class="n">id0</span><span class="p">,</span> 
                       <span class="n">write_results</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">frac_long_wave</span><span class="p">,</span><span class="n">min_steps</span><span class="p">,</span>
                       <span class="n">test_shape_func</span><span class="p">,</span><span class="n">doe2_in</span><span class="p">,</span> <span class="n">max_E_dist</span><span class="p">,</span><span class="n">del_max_E_dist</span><span class="p">,</span>
                       <span class="n">min_E_dist</span><span class="p">,</span><span class="n">del_min_E_dist</span><span class="p">,</span> <span class="n">new_input_format</span><span class="p">,</span>
                       <span class="n">climate_temp_func</span><span class="p">,</span><span class="n">averaging_steps</span><span class="p">,</span><span class="n">rng</span><span class="p">,</span> <span class="n">no_climate_trend</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="n">doe2_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">objA</span> <span class="o">=</span> <span class="n">Alter</span><span class="p">(</span><span class="n">wfile</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">objA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DOE2Alter</span><span class="p">(</span><span class="n">wfile</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">doe2_in</span><span class="p">)</span>
            
        <span class="n">org_series</span> <span class="o">=</span> <span class="n">objA</span><span class="o">.</span><span class="n">epwobj</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
        <span class="n">org_dates</span> <span class="o">=</span> <span class="n">objA</span><span class="o">.</span><span class="n">reindex_2_datetime</span><span class="p">(</span><span class="n">tzname</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
        <span class="n">num_step</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">objA</span><span class="o">.</span><span class="n">epwobj</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_input_format</span><span class="p">:</span>
            <span class="n">state0</span> <span class="o">=</span> <span class="s2">&quot;normal&quot;</span>
            <span class="n">states_arr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">month</span><span class="p">,</span> <span class="n">trans_matrix</span> <span class="ow">in</span> <span class="n">transition_matrix</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">month_num_steps</span> <span class="o">=</span> <span class="p">(</span><span class="n">org_dates</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                
                <span class="n">modified_trans_matrix</span> <span class="o">=</span> <span class="n">trans_matrix</span> <span class="o">+</span> <span class="n">transition_matrix_delta</span><span class="p">[</span><span class="n">month</span><span class="p">]</span>
                
                <span class="n">objDM</span> <span class="o">=</span> <span class="n">DiscreteMarkov</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">modified_trans_matrix</span><span class="p">,</span> 
                                       <span class="n">state_name</span><span class="p">,</span> <span class="n">use_cython</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">states_arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">states_arr</span> <span class="o">=</span> <span class="n">objDM</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">month_num_steps</span><span class="p">,</span> <span class="n">state0</span><span class="p">,</span><span class="n">count_in_min_steps_intervals</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">states_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">states_arr</span><span class="p">,</span> <span class="n">objDM</span><span class="o">.</span><span class="n">history</span><span class="p">(</span>
                                    <span class="n">month_num_steps</span><span class="p">,</span> 
                                    <span class="n">state0</span><span class="p">,</span>
                                    <span class="n">count_in_min_steps_intervals</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>
                
                <span class="n">state0</span> <span class="o">=</span> <span class="n">state_name</span><span class="p">[</span><span class="n">states_arr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            
            <span class="c1">#import matplotlib.pyplot as plt</span>
            <span class="c1">#plt.plot(states_arr)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">objDM</span> <span class="o">=</span> <span class="n">DiscreteMarkov</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span><span class="n">transition_matrix</span> 
                               <span class="o">+</span> <span class="n">transition_matrix_delta</span> 
                               <span class="o">*</span> <span class="p">(</span><span class="n">year</span> <span class="o">-</span> <span class="n">start_year</span><span class="p">),</span>
                               <span class="n">state_name</span><span class="p">,</span><span class="n">use_cython</span><span class="p">)</span>
        <span class="c1"># distinguish the shape function type</span>
        <span class="k">if</span> <span class="n">new_input_format</span><span class="p">:</span>
            <span class="n">shape_function_type</span> <span class="o">=</span> <span class="s2">&quot;heat_wave_shape_func&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shape_function_type</span> <span class="o">=</span> <span class="s2">&quot;double_shape_func&quot;</span>
        
            <span class="c1"># generate a history</span>
            <span class="n">states_arr</span> <span class="o">=</span> <span class="n">objDM</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">num_step</span><span class="p">,</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span><span class="n">min_steps</span><span class="o">=</span><span class="n">min_steps</span><span class="p">)</span>
        <span class="c1"># separate history into extreme states.</span>
        <span class="n">state_intervals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_extreme_intervals</span><span class="p">(</span><span class="n">states_arr</span><span class="p">,</span> <span class="n">state_int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">state</span><span class="p">,</span> <span class="n">s_ind</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">state_intervals</span><span class="p">,</span><span class="n">state_int</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">s_ind</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># shift cold snaps to start at noon whereas heat waves </span>
                <span class="c1"># start at mid-night</span>
                <span class="n">shifted_state</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
                    <span class="n">tup_try</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">min_steps</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">min_steps</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">tup_try</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">states_arr</span><span class="p">)</span> <span class="ow">or</span> <span class="n">tup_try</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">states_arr</span><span class="p">):</span> <span class="c1"># go back</span>
                        <span class="n">tup_try</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">min_steps</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">min_steps</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">shifted_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tup_try</span><span class="p">)</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">shifted_state</span>


                <span class="k">if</span> <span class="n">new_input_format</span><span class="p">:</span>
                    <span class="n">avg_dist</span> <span class="o">=</span> <span class="n">min_E_dist</span> 
                    <span class="n">peak_dist</span> <span class="o">=</span> <span class="n">min_avg_dist</span>  <span class="c1"># minimum temperature</span>
                    <span class="n">peak_delta</span> <span class="o">=</span> <span class="n">min_avg_delta</span>
                    <span class="n">avg_delta</span> <span class="o">=</span> <span class="n">del_min_E_dist</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">avg_dist</span> <span class="o">=</span> <span class="n">min_avg_dist</span>
                    <span class="n">peak_dist</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">peak_delta</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">avg_delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">year</span> <span class="o">-</span> <span class="n">start_year</span><span class="p">)</span> <span class="o">*</span> <span class="n">min_avg_delta</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wave_shift</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="n">new_input_format</span><span class="p">:</span>
                    <span class="n">avg_dist</span> <span class="o">=</span> <span class="n">max_E_dist</span>
                    <span class="n">peak_dist</span> <span class="o">=</span> <span class="n">max_avg_dist</span>
                    <span class="n">peak_delta</span> <span class="o">=</span> <span class="n">max_avg_delta</span>
                    <span class="n">avg_delta</span> <span class="o">=</span> <span class="n">del_max_E_dist</span>
                <span class="k">else</span><span class="p">:</span>    
                    <span class="n">avg_dist</span> <span class="o">=</span> <span class="n">max_avg_dist</span>
                    <span class="n">peak_dist</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">peak_delta</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">avg_delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">year</span> <span class="o">-</span> <span class="n">start_year</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_avg_delta</span>
                    
                
            <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
                <span class="n">new_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_extreme</span><span class="p">(</span><span class="n">org_series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> 
                                  <span class="n">avg_dist</span><span class="p">,</span> <span class="n">avg_delta</span><span class="p">,</span>
                                  <span class="n">frac_long_wave</span><span class="o">=</span><span class="n">frac_long_wave</span><span class="p">,</span>
                                  <span class="n">min_steps</span><span class="o">=</span><span class="n">min_steps</span><span class="p">,</span>
                                  <span class="n">shape_func_type</span><span class="o">=</span><span class="n">shape_function_type</span><span class="p">,</span>
                                  <span class="n">test_shape_func</span><span class="o">=</span><span class="n">test_shape_func</span><span class="p">,</span>
                                  <span class="n">peak_dist</span><span class="o">=</span><span class="n">peak_dist</span><span class="p">,</span>
                                  <span class="n">peak_delta</span><span class="o">=</span><span class="n">peak_delta</span><span class="p">,</span>
                                  <span class="n">org_dates</span><span class="o">=</span><span class="n">org_dates</span><span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                                  <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

                <span class="n">new_date_start</span> <span class="o">=</span> <span class="n">org_dates</span><span class="p">[</span><span class="n">new_vals</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_vals</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">s_ind</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">peak_delta_val</span> <span class="o">=</span> <span class="n">new_vals</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">peak_delta_val</span> <span class="o">=</span> <span class="n">new_vals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    
                <span class="n">objA</span><span class="o">.</span><span class="n">add_alteration</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> 
                                    <span class="n">new_date_start</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> 
                                    <span class="n">new_date_start</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> 
                                    <span class="n">new_date_start</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> 
                                    <span class="n">duration</span><span class="p">,</span> <span class="n">peak_delta_val</span><span class="p">,</span>
                                    <span class="n">shape_func</span><span class="o">=</span><span class="n">new_vals</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                    <span class="n">column</span><span class="o">=</span><span class="n">column</span><span class="p">,</span>
                                    <span class="n">averaging_steps</span><span class="o">=</span><span class="n">averaging_steps</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">climate_temp_func</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">no_climate_trend</span><span class="p">:</span>
            <span class="c1"># TODO - add the ability to continuously change the trend or to</span>
            <span class="c1">#        just make it constant like it is now.</span>
            <span class="n">objA</span><span class="o">.</span><span class="n">add_alteration</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">num_step</span><span class="p">,</span><span class="n">climate_temp_func</span><span class="p">(</span><span class="n">year</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_step</span><span class="p">),</span>
                                <span class="n">alteration_name</span><span class="o">=</span><span class="s2">&quot;global temperature trend&quot;</span><span class="p">)</span>
                
                
        <span class="k">if</span> <span class="n">write_results</span><span class="p">:</span>
            <span class="c1"># TODO, this writing needs to be standardized accross all</span>
            <span class="c1"># alteration combinations!</span>
            <span class="k">if</span> <span class="n">doe2_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">simple_call</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doe2_in</span><span class="p">,</span><span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;txt2bin_exepath&#39;</span> <span class="ow">in</span> <span class="n">doe2_in</span><span class="p">:</span>
                <span class="n">simple_call</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">simple_call</span> <span class="o">=</span> <span class="kc">False</span> 
            
            
            <span class="n">new_wfile_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">wfile</span><span class="p">)[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> 
                         <span class="o">+</span> <span class="n">results_append_to_name</span> 
                         <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{0:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> 
                         <span class="o">+</span> <span class="s2">&quot;_r</span><span class="si">{0:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id0</span><span class="p">)</span>
                         <span class="o">+</span> <span class="n">wfile</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:])</span>
            
            <span class="k">if</span> <span class="n">simple_call</span><span class="p">:</span>
                <span class="n">objA</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results_folder</span><span class="p">,</span><span class="n">new_wfile_name</span><span class="p">),</span> 
                              <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">create_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">objA</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results_folder</span><span class="p">,</span><span class="n">new_wfile_name</span><span class="p">),</span> 
                              <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">create_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">txt2bin_exepath</span><span class="o">=</span><span class="n">doe2_in</span><span class="p">[</span><span class="s1">&#39;txt2bin_exepath&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfile_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_wfile_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">objA</span>
    
    <span class="k">def</span> <span class="nf">_DOE2Alter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wfile</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">doe2_in</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doe2_in</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The doe2 input must be a dictionary!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;doe2_bin2txt_path&#39;</span> <span class="ow">in</span> <span class="n">doe2_in</span><span class="p">:</span>
            <span class="n">doe2_bin2txt_path</span><span class="o">=</span><span class="n">doe2_in</span><span class="p">[</span><span class="s1">&#39;doe2_bin2txt_path&#39;</span><span class="p">]</span>
            <span class="n">objA</span> <span class="o">=</span> <span class="n">Alter</span><span class="p">(</span><span class="n">wfile</span><span class="p">,</span><span class="n">year</span><span class="p">,</span>
                         <span class="n">isdoe2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">doe2_bin2txt_path</span><span class="o">=</span><span class="n">doe2_bin2txt_path</span><span class="p">,</span>
                         <span class="n">doe2_start_datetime</span><span class="o">=</span><span class="n">doe2_in</span><span class="p">[</span><span class="s1">&#39;doe2_start_datetime&#39;</span><span class="p">],</span>
                         <span class="n">doe2_hour_in_file</span><span class="o">=</span><span class="n">doe2_in</span><span class="p">[</span><span class="s1">&#39;doe2_hour_in_file&#39;</span><span class="p">],</span>
                         <span class="n">doe2_tz</span><span class="o">=</span><span class="n">doe2_in</span><span class="p">[</span><span class="s1">&#39;doe2_tz&#39;</span><span class="p">],</span>
                         <span class="n">doe2_dst</span><span class="o">=</span><span class="n">doe2_in</span><span class="p">[</span><span class="s1">&#39;doe2_dst&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">objA</span> <span class="o">=</span> <span class="n">Alter</span><span class="p">(</span><span class="n">wfile</span><span class="p">,</span><span class="n">year</span><span class="p">,</span>
                         <span class="n">isdoe2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">doe2_start_datetime</span><span class="o">=</span><span class="n">doe2_in</span><span class="p">[</span><span class="s1">&#39;doe2_start_datetime&#39;</span><span class="p">],</span>
                         <span class="n">doe2_hour_in_file</span><span class="o">=</span><span class="n">doe2_in</span><span class="p">[</span><span class="s1">&#39;doe2_hour_in_file&#39;</span><span class="p">],</span>
                         <span class="n">doe2_tz</span><span class="o">=</span><span class="n">doe2_in</span><span class="p">[</span><span class="s1">&#39;doe2_tz&#39;</span><span class="p">],</span>
                         <span class="n">doe2_dst</span><span class="o">=</span><span class="n">doe2_in</span><span class="p">[</span><span class="s1">&#39;doe2_dst&#39;</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">objA</span>

    <span class="k">def</span> <span class="nf">_find_extreme_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">states_arr</span><span class="p">,</span><span class="n">states</span><span class="p">):</span>
        <span class="n">diff_states</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">states</span><span class="p">)))</span>
        <span class="n">state_int_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="n">state_ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">states_arr</span><span class="o">==</span><span class="n">state</span><span class="p">)</span> <span class="k">if</span> <span class="n">val</span><span class="p">]</span>
            <span class="n">end_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">state_ind</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">val</span><span class="p">]</span>
            <span class="n">start_point</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">end_points</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">state_ind</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ep_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">state_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">state_ind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">end_points</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">state_ind</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ep_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ep_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="n">end_points</span><span class="p">:</span>
                    <span class="n">ep_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">state_ind</span><span class="p">[</span><span class="n">start_point</span><span class="p">],</span><span class="n">state_ind</span><span class="p">[</span><span class="n">ep</span><span class="p">]))</span>
                    <span class="n">start_point</span> <span class="o">=</span> <span class="n">ep</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">state_int_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ep_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state_int_list</span>

<div class="viewcode-block" id="Extremes.double_shape_func"><a class="viewcode-back" href="../../../mews.stats.extreme.html#mews.stats.extreme.Extremes.double_shape_func">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">double_shape_func</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">min_s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">A</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">D</span><span class="p">)</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">min_s</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Extremes.heat_wave_shape_func"><a class="viewcode-back" href="../../../mews.stats.extreme.html#mews.stats.extreme.Extremes.heat_wave_shape_func">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">heat_wave_shape_func</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">D_odd</span><span class="p">,</span><span class="n">min_s</span><span class="p">):</span>
        
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t</span><span class="o">&gt;</span><span class="n">D_odd</span><span class="p">,</span>
                 <span class="n">B</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">t</span><span class="o">/</span><span class="n">min_s</span><span class="p">)),</span>
                 <span class="n">A</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">t</span> <span class="o">/</span> <span class="n">D_odd</span><span class="p">)</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">t</span><span class="o">/</span><span class="n">min_s</span><span class="p">)))</span></div>
<div class="viewcode-block" id="Extremes.total_energy_integral"><a class="viewcode-back" href="../../../mews.stats.extreme.html#mews.stats.extreme.Extremes.total_energy_integral">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">total_energy_integral</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">D_odd</span><span class="p">,</span><span class="n">min_s</span><span class="p">,</span><span class="n">is_hw</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_hw</span><span class="p">:</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">A</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
            <span class="n">B</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="n">D_odd</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">D</span> <span class="o">-</span> <span class="n">B</span> <span class="o">*</span> <span class="n">min_s</span> <span class="o">/</span> <span class="p">(</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">D</span> <span class="o">/</span> <span class="n">min_s</span><span class="p">)</span></div>
        
    
    <span class="k">def</span> <span class="nf">_add_extreme</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">org_vals</span><span class="p">,</span><span class="n">integral_dist</span><span class="p">,</span><span class="n">integral_delta</span><span class="p">,</span><span class="n">frac_long_wave</span><span class="p">,</span><span class="n">min_steps</span><span class="p">,</span>
                     <span class="n">shape_func_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">test_shape_func</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">peak_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">peak_delta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">org_dates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &gt;&gt;&gt; obj._add_extreme(org_vals,</span>
<span class="sd">                             integral_dist,</span>
<span class="sd">                             integral_delta,</span>
<span class="sd">                             frac_long_wave=1.0,</span>
<span class="sd">                             min_steps,</span>
<span class="sd">                             shape_func_type=None,</span>
<span class="sd">                             test_shape_func=False,</span>
<span class="sd">                             peak_dist=None,</span>
<span class="sd">                             peak_delta=None)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        org_vals : pandas.Series</span>
<span class="sd">            Original values for weather over the duration of an inserted </span>
<span class="sd">            extreme event.</span>
<span class="sd">            </span>
<span class="sd">        integral_dist : function</span>
<span class="sd">            Random number generating function for the integral of total energy</span>
<span class="sd">            over the duration of the extreme event (returns total energy).</span>
<span class="sd">            </span>
<span class="sd">        integral_delta : float</span>
<span class="sd">            Delta amount to energy intensity of extreme event (due to climate</span>
<span class="sd">            change).</span>
<span class="sd">            </span>
<span class="sd">        frac_long_wave : float 1 &gt; frac_long_wave &gt; 0</span>
<span class="sd">            Amount of heat added that is attributed to a sinusoidal function </span>
<span class="sd">            accross the entire duration of the heat wave. The remainder is </span>
<span class="sd">            applied to increases in daily heat.</span>
<span class="sd">            </span>
<span class="sd">        min_steps : int &gt; 0</span>
<span class="sd">            Minimum number of steps heat waves must begin and end on (e.g. if</span>
<span class="sd">            min_steps=24, then a heat wave can only begin and end at the </span>
<span class="sd">            beginning of a new day).</span>
<span class="sd">            </span>
<span class="sd">        shape_func_type : str : optional : Default = None</span>
<span class="sd">            The name of the function that is to be used. If a new shape</span>
<span class="sd">            is desired, then a new function has to be hard coded into extremes</span>
<span class="sd">            TODO - generalize this to any shape function input.</span>
<span class="sd">            </span>
<span class="sd">        test_shape_func : bool : optional  </span>
<span class="sd">            For testing purposes:</span>
<span class="sd">                Boolean indicating whether computationally expensive testing is </span>
<span class="sd">                done to assure the shape function used integrates to the original</span>
<span class="sd">                heat_added. Default value is False - True is needed for unittesting.</span>

<span class="sd">        peak_dist : function : optional </span>
<span class="sd">            Only for new input structure:</span>
<span class="sd">                Random number generating function for the peak temperature per duration.</span>
<span class="sd">            </span>
<span class="sd">        peak_delta : dict : optional</span>
<span class="sd">            Only for new input structure:</span>
<span class="sd">                Delta on each parameter of peak_dist due to climate change.</span>
<span class="sd">            </span>
<span class="sd">        org_dates : pd.Series : optional </span>
<span class="sd">            Only for new input structure:</span>
<span class="sd">                Allows calculation of which months the heat wave start date began in.</span>
<span class="sd">            </span>
<span class="sd">        rng : optional : Default = None</span>
<span class="sd">            Random number generator. If None, then use self.rng</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        new_vals :  </span>
<span class="sd">            Values to add to org_vals in the weather history to produce a new</span>
<span class="sd">            extreme event.</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="n">duration</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">org_vals</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">rng</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span>
            
        
        <span class="c1"># these are determined by taking the integral of &quot;double_shape_func&quot; from</span>
        <span class="c1"># 0 to D and equating it to heat_added times frac_long_wave for the sine term</span>
        <span class="c1"># and to (1-frac_long_wave) for the 1-cos term. </span>
        <span class="k">if</span> <span class="n">shape_func_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">shape_func_type</span> <span class="o">==</span> <span class="s2">&quot;double_shape_func&quot;</span><span class="p">:</span>
            <span class="c1"># this is the old method code - eventually we want to depricate this</span>
            <span class="c1"># but it is retained so that MEWS can replicate earlier study results.</span>
            
            <span class="c1"># heat added per hour duration of the heat wave</span>
            <span class="n">heat_added</span> <span class="o">=</span> <span class="p">(</span><span class="n">integral_dist</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="o">+</span><span class="n">integral_delta</span><span class="p">)</span> <span class="o">*</span> <span class="n">duration</span>
            <span class="n">term1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">min_steps</span><span class="p">)</span>
            <span class="n">Acoef</span> <span class="o">=</span> <span class="n">frac_long_wave</span> <span class="o">*</span> <span class="n">heat_added</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">duration</span><span class="p">)</span>
            <span class="n">Bcoef</span> <span class="o">=</span> <span class="n">term1</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">frac_long_wave</span><span class="p">)</span> <span class="o">*</span> <span class="n">heat_added</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">duration</span><span class="o">*</span><span class="n">term1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">term1</span><span class="o">*</span><span class="n">duration</span><span class="p">))</span>
            
            <span class="c1"># for unit testing, assure the shape function used integrates </span>
            <span class="c1"># correctly</span>
            <span class="k">if</span> <span class="n">test_shape_func</span><span class="p">:</span>
                <span class="n">acceptable_error_percent</span> <span class="o">=</span> <span class="mf">0.1</span>
                <span class="c1"># 100 steps per day.</span>
                <span class="n">xval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">duration</span><span class="p">,</span><span class="n">duration</span><span class="o">/</span><span class="p">(</span><span class="mi">24</span><span class="o">*</span><span class="mi">100</span><span class="p">)))</span>

                <span class="n">h_test</span> <span class="o">=</span> <span class="n">Extremes</span><span class="o">.</span><span class="n">double_shape_func</span><span class="p">(</span><span class="n">xval</span><span class="p">,</span><span class="n">Acoef</span><span class="p">,</span><span class="n">Bcoef</span><span class="p">,</span><span class="n">duration</span><span class="p">,</span><span class="n">min_steps</span><span class="p">)</span>
                <span class="n">h_test_heat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">h_test</span><span class="p">,</span><span class="n">xval</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">h_test_heat</span> <span class="o">-</span> <span class="n">heat_added</span><span class="p">)</span><span class="o">/</span><span class="n">heat_added</span> <span class="o">&gt;</span> <span class="n">acceptable_error_percent</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ExtremesIntegrationError</span><span class="p">(</span><span class="s2">&quot;The heat wave increased &quot;</span>
                                               <span class="o">+</span><span class="s2">&quot;temperature did not integrate to&quot;</span>
                                               <span class="o">+</span><span class="s2">&quot; the heat_added. This should&quot;</span>
                                               <span class="o">+</span><span class="s2">&quot; never happen. There is a bug.&quot;</span><span class="p">)</span>
            
            <span class="n">h_t</span> <span class="o">=</span> <span class="n">Extremes</span><span class="o">.</span><span class="n">double_shape_func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">duration</span><span class="p">)),</span><span class="n">Acoef</span><span class="p">,</span><span class="n">Bcoef</span><span class="p">,</span><span class="n">duration</span><span class="p">,</span><span class="n">min_steps</span><span class="p">)</span>
            <span class="c1"># renormalize to make hourly approximation exactly fit heat_added</span>
            <span class="n">h_t</span> <span class="o">=</span> <span class="n">heat_added</span> <span class="o">*</span> <span class="n">h_t</span> <span class="o">/</span> <span class="n">h_t</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            
            <span class="n">new_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">h_t</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">org_vals</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">org_vals</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">org_vals</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="n">shape_func_type</span> <span class="o">==</span> <span class="s2">&quot;heat_wave_shape_func&quot;</span><span class="p">:</span>
            <span class="c1"># THIS IS HIGHLY REPETITIVE - perhaps some code refactoring would be appropriate</span>
            <span class="c1"># the month of the start date determines the sampling parameters</span>

            <span class="c1"># statistics come from the month with he majority of hours in.</span>
            <span class="n">s_month</span> <span class="o">=</span> <span class="n">org_dates</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">org_dates</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> 
                        <span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">org_dates</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">unique</span><span class="p">()]</span>
                                                        <span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span>

            <span class="n">param</span> <span class="o">=</span> <span class="n">integral_dist</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="n">s_month</span><span class="p">]</span>
            
            <span class="c1"># trunc_norm_dist(rnd,mu,sig,a,b,minval,maxval)</span>
            <span class="n">mu_E</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;energy_normal_param&#39;</span><span class="p">][</span><span class="s1">&#39;mu&#39;</span><span class="p">]</span>
            <span class="n">sig_E</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;energy_normal_param&#39;</span><span class="p">][</span><span class="s1">&#39;sig&#39;</span><span class="p">]</span>
            <span class="n">maxval_E</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;max energy per duration&#39;</span><span class="p">]</span>
            <span class="n">minval_E</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;min energy per duration&#39;</span><span class="p">]</span>
            <span class="n">norm_energy</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;normalizing energy&#39;</span><span class="p">]</span>
            <span class="n">norm_duration</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;normalizing duration&#39;</span><span class="p">]</span>
            <span class="n">alpha_E</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;energy linear slope&#39;</span><span class="p">]</span>
            <span class="n">mu_T</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;extreme_temp_normal_param&#39;</span><span class="p">][</span><span class="s1">&#39;mu&#39;</span><span class="p">]</span>
            <span class="n">sig_T</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;extreme_temp_normal_param&#39;</span><span class="p">][</span><span class="s1">&#39;sig&#39;</span><span class="p">]</span>
            <span class="n">maxval_T</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;max extreme temp per duration&#39;</span><span class="p">]</span>
            <span class="n">minval_T</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;min extreme temp per duration&#39;</span><span class="p">]</span>
            <span class="n">norm_temperature</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;normalizing extreme temp&#39;</span><span class="p">]</span>
            <span class="n">alpha_T</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;normalized extreme temp duration fit slope&#39;</span><span class="p">]</span>
            <span class="n">beta_T</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;normalized extreme temp duration fit intercept&#39;</span><span class="p">]</span>
            <span class="n">Sm1_E</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">Sm1_T</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">S_E</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">S_T</span> <span class="o">=</span> <span class="mf">0.0</span>
            
            <span class="c1"># introduce a delta if it exists.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">integral_delta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">param_delta</span> <span class="o">=</span> <span class="n">integral_delta</span><span class="p">[</span><span class="n">s_month</span><span class="p">]</span>
                <span class="n">mu_E</span> <span class="o">+=</span> <span class="n">param_delta</span><span class="p">[</span><span class="s1">&#39;del_mu&#39;</span><span class="p">]</span>
                <span class="n">sig_E</span> <span class="o">+=</span> <span class="n">param_delta</span><span class="p">[</span><span class="s1">&#39;del_sig&#39;</span><span class="p">]</span>
                <span class="n">Sm1_E</span> <span class="o">+=</span> <span class="n">param_delta</span><span class="p">[</span><span class="s1">&#39;del_a&#39;</span><span class="p">]</span>
                <span class="n">S_E</span> <span class="o">+=</span> <span class="n">param_delta</span><span class="p">[</span><span class="s1">&#39;del_b&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">peak_delta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">peak_param_delta</span> <span class="o">=</span> <span class="n">peak_delta</span><span class="p">[</span><span class="n">s_month</span><span class="p">]</span>
                <span class="n">mu_T</span> <span class="o">+=</span> <span class="n">peak_param_delta</span><span class="p">[</span><span class="s1">&#39;del_mu&#39;</span><span class="p">]</span>
                <span class="n">sig_T</span> <span class="o">+=</span> <span class="n">peak_param_delta</span><span class="p">[</span><span class="s1">&#39;del_sig&#39;</span><span class="p">]</span>
                <span class="n">Sm1_T</span> <span class="o">+=</span> <span class="n">peak_param_delta</span><span class="p">[</span><span class="s1">&#39;del_a&#39;</span><span class="p">]</span>
                <span class="n">S_T</span> <span class="o">+=</span> <span class="n">peak_param_delta</span><span class="p">[</span><span class="s1">&#39;del_b&#39;</span><span class="p">]</span>                
                
                
            <span class="c1"># integral_dist - includes the inverse transform back to </span>
            <span class="c1"># energy per duration from the -1..1 space (-1..1 gets shifted so it</span>
            <span class="c1"># is not strictly -1..1)</span>
            <span class="n">iter0</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">max_iter</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="n">found_physical_solution</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="c1">#TODO - you need more work on the relationship between peak </span>
            <span class="c1">#       temperature and total energy</span>
            
            <span class="n">E_per_duration</span> <span class="o">=</span> <span class="n">integral_dist</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">](</span><span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                                   <span class="n">mu_E</span><span class="p">,</span>
                                                   <span class="n">sig_E</span><span class="p">,</span>
                                                   <span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">Sm1_E</span><span class="p">,</span>
                                                   <span class="mi">1</span><span class="o">+</span><span class="n">S_E</span><span class="p">,</span>
                                                   <span class="n">minval_E</span><span class="p">,</span>
                                                   <span class="n">maxval_E</span><span class="p">)</span>
            <span class="n">T_per_duration</span> <span class="o">=</span> <span class="n">integral_dist</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">](</span><span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                                   <span class="n">mu_T</span><span class="p">,</span>
                                                   <span class="n">sig_T</span><span class="p">,</span>
                                                   <span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">Sm1_T</span><span class="p">,</span>
                                                   <span class="mi">1</span><span class="o">+</span><span class="n">S_T</span><span class="p">,</span>
                                                   <span class="n">minval_T</span><span class="p">,</span>
                                                   <span class="n">maxval_T</span><span class="p">)</span>
            
            <span class="n">heat_added</span> <span class="o">=</span> <span class="n">E_per_duration</span> <span class="o">*</span> <span class="n">norm_energy</span> <span class="o">*</span> <span class="n">alpha_E</span> <span class="o">*</span> <span class="p">(</span><span class="n">duration</span><span class="o">/</span><span class="n">norm_duration</span><span class="p">)</span>
            <span class="n">Tmax</span> <span class="o">=</span> <span class="n">T_per_duration</span> <span class="o">*</span> <span class="n">norm_temperature</span> <span class="o">*</span> <span class="p">(</span><span class="n">alpha_T</span> <span class="o">*</span> <span class="p">(</span><span class="n">duration</span><span class="o">/</span><span class="n">norm_duration</span><span class="p">)</span> <span class="o">+</span> <span class="n">beta_T</span><span class="p">)</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">duration</span>
            
            <span class="c1"># calculate D_odd</span>
            <span class="n">Dint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">duration</span><span class="o">/</span><span class="n">min_steps</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">Dint</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">Dint</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">D_odd</span> <span class="o">=</span> <span class="n">Dint</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">Dint</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">D_odd</span> <span class="o">=</span> <span class="n">Dint</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Dint</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">D_odd</span> <span class="o">=</span> <span class="n">D_odd</span> <span class="o">*</span> <span class="n">min_steps</span>
            
            <span class="c1"># determine E and Tmax coefficients</span>
            <span class="n">Acoef</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tmax</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D_odd</span><span class="p">)</span> <span class="o">*</span> <span class="n">heat_added</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">D</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">D_odd</span><span class="p">)</span>
                                                  <span class="o">+</span> <span class="p">(</span><span class="n">min_steps</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D_odd</span><span class="p">))</span> <span class="o">*</span> 
                                                  <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">D</span><span class="o">/</span><span class="n">min_steps</span><span class="p">))</span>
            <span class="n">Bcoef</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tmax</span> <span class="o">-</span> <span class="n">Acoef</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            
            <span class="k">if</span> <span class="n">test_shape_func</span><span class="p">:</span>
                
                <span class="n">acceptable_error_percent</span> <span class="o">=</span> <span class="mf">0.1</span>
                <span class="c1"># 100 steps per day.</span>
                <span class="n">xval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">duration</span><span class="p">,</span><span class="n">duration</span><span class="o">/</span><span class="p">(</span><span class="mi">24</span><span class="o">*</span><span class="mi">100</span><span class="p">)))</span>
    
                <span class="n">h_test</span> <span class="o">=</span> <span class="n">Extremes</span><span class="o">.</span><span class="n">heat_wave_shape_func</span><span class="p">(</span><span class="n">xval</span><span class="p">,</span><span class="n">Acoef</span><span class="p">,</span><span class="n">Bcoef</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">D_odd</span><span class="p">,</span><span class="n">min_steps</span><span class="p">)</span>
                <span class="n">h_test_heat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">h_test</span><span class="p">,</span><span class="n">xval</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">h_test_heat</span> <span class="o">-</span> <span class="n">heat_added</span><span class="p">)</span><span class="o">/</span><span class="n">heat_added</span> <span class="o">&gt;</span> <span class="n">acceptable_error_percent</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ExtremesIntegrationError</span><span class="p">(</span><span class="s2">&quot;The heat wave increased &quot;</span>
                                               <span class="o">+</span><span class="s2">&quot;temperature did not integrate to&quot;</span>
                                               <span class="o">+</span><span class="s2">&quot; the heat_added. This should&quot;</span>
                                               <span class="o">+</span><span class="s2">&quot; never happen. There is a bug.&quot;</span><span class="p">)</span>
            
            <span class="c1"># adjust to meet Tmax but not E if the solution is non-physical.</span>
            <span class="n">dual_solution</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">heat_added</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">Acoef</span> <span class="o">&gt;</span> <span class="n">Tmax</span><span class="p">:</span>
                <span class="n">Acoef</span> <span class="o">=</span> <span class="n">Tmax</span>
                <span class="n">Bcoef</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">elif</span> <span class="n">heat_added</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">Acoef</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">Bcoef</span> <span class="o">=</span> <span class="n">Tmax</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">Acoef</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">elif</span> <span class="n">heat_added</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">Acoef</span> <span class="o">&lt;</span> <span class="n">Tmax</span><span class="p">:</span>
                <span class="n">Acoef</span> <span class="o">=</span> <span class="n">Tmax</span>
                <span class="n">Bcoef</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">elif</span> <span class="n">heat_added</span> <span class="o">&lt;=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">Acoef</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">Acoef</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">Bcoef</span> <span class="o">=</span> <span class="n">Tmax</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dual_solution</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">Bcoef</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tmax</span> <span class="o">-</span> <span class="n">Acoef</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            
            <span class="k">if</span> <span class="n">iter0</span> <span class="o">&gt;=</span> <span class="n">max_iter</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The E and Tmax sampling could not find a physically real solution!&quot;</span><span class="p">)</span>
                
            <span class="c1"># for unit testing, assure the shape function used integrates </span>
            <span class="c1"># correctly</span>
     
            <span class="n">h_t</span> <span class="o">=</span> <span class="n">Extremes</span><span class="o">.</span><span class="n">heat_wave_shape_func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">duration</span><span class="p">)),</span><span class="n">Acoef</span><span class="p">,</span><span class="n">Bcoef</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">D_odd</span><span class="p">,</span><span class="n">min_steps</span><span class="p">)</span>
            
            <span class="c1"># renormalize to make hourly approximation exactly fit heat_added</span>
            <span class="k">if</span> <span class="n">dual_solution</span><span class="p">:</span>
                <span class="n">h_t</span> <span class="o">=</span> <span class="n">heat_added</span> <span class="o">*</span> <span class="n">h_t</span> <span class="o">/</span> <span class="n">h_t</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            
            <span class="n">new_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">h_t</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">org_vals</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">org_vals</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">org_vals</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MEWS currently only can have &#39;double_shape_func&#39; or &#39;heat_wave_shape_func&#39;&quot;</span> <span class="o">+</span>
                             <span class="s2">&quot; as values for the shape_func_type input&quot;</span><span class="p">)</span>
        

        
        <span class="k">return</span> <span class="n">new_vals</span></div>
        
        
        
                
                
            
        
        
        
    
    
    

    

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, National Technology and Engineering Solutions of Sandia, LLC.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>